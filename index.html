<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CronoSysPOS v2.1</title>
    
    <!-- 1. Estilos (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Configuraci√≥n de Iconos y Librer√≠as -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Librer√≠a para escanear con c√°mara (QR/Barras) -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Librer√≠a para Tablas en PDF (AutoTable) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- 3. React y Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        body { user-select: none; } 
        .barcode-scan { animation: scanLine 2s infinite linear; }
        @keyframes scanLine { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
        
        /* Animaciones */
        @keyframes slideInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .msg-anim { animation: slideInUp 0.3s ease-out forwards; }
        
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-anim { animation: zoomIn 0.2s ease-out forwards; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-anim { animation: fadeIn 0.2s ease-out forwards; }
        
        /* Animaci√≥n Alarma */
        @keyframes alarmFlash {
            0% { background-color: #fee2e2; }
            50% { background-color: #ef4444; color: white; }
            100% { background-color: #fee2e2; }
        }
        .alarm-active { animation: alarmFlash 1s infinite; }
    </style>
</head>
<!-- FONDO GRIS PLATEADO OSCURO -->
<body class="bg-slate-300">
    <div id="root"></div>

    <!-- 4. TU C√ìDIGO DEL SISTEMA -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        
        // --- CONSTANTES ---
// Utilizamos window para almacenar variables globales solo si no existen a√∫n, evitando redeclaraci√≥n
window.EMPRESA = window.EMPRESA || "CIBER CENTRO PROGRESO";
window.RFC = window.RFC || "PEGU911012KC3";
window.REGIMEN = window.REGIMEN || "R√©gimen Simplificado de Confianza";
window.DIRECCION = window.DIRECCION || "Plaza Principal 6, Progreso C.P. 42987";
window.LUGAR_EXPEDICION = window.LUGAR_EXPEDICION || "Progreso, Hidalgo";
        // Utilizamos window para almacenar variables globales solo si no existen a√∫n, evitando redeclaraci√≥n
        window.SISTEMA = window.SISTEMA || "v2.2";
        window.COLOR_CORP = window.COLOR_CORP || "bg-slate-900";
        window.RATIO_PUNTOS = window.RATIO_PUNTOS || 10;
        
        // --- SONIDOS DEL SISTEMA ---
        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);

                if (type === 'warning') { // Alarma Suave
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(440, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.5);
                } else if (type === 'alarm') { // Alarma Fuerte
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(800, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.5);
                    gain.gain.setValueAtTime(0.2, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1);
                    osc.start();
                    osc.stop(ctx.currentTime + 1);
                } else if (type === 'scan') { // Beep de Escaneo
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(1200, ctx.currentTime);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.1);
                } else if (type === 'success') { // √âxito (Venta)
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(600, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.2);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.3);
                }
            } catch (e) { console.error("Audio error", e); }
        };

        // --- ADAPTADOR DE ICONOS LUCIDE ---
        const LucideIconWrapper = ({ name, size = 24, className = "", ...props }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide) {
                    const kebabName = name.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
                    const iTag = document.createElement('i');
                    iTag.setAttribute('data-lucide', kebabName);
                    if (className) iTag.className = className;
                    ref.current.innerHTML = '';
                    ref.current.appendChild(iTag);
                    window.lucide.createIcons({
                        root: ref.current,
                        nameAttr: 'data-lucide',
                        attrs: { width: size, height: size, class: `lucide lucide-${kebabName} ${className}` }
                    });
                }
            }, [name, size, className]);
            return <span ref={ref} style={{ display: 'inline-flex', verticalAlign: 'middle' }} {...props}></span>;
        };

        const iconNames = [
            'Monitor', 'Gamepad2', 'Play', 'Pause', 'Square', 'Coffee', 'Printer', 'X', 
            'DollarSign', 'ShoppingBag', 'Users', 'Ticket', 'PlusCircle', 'CheckCircle', 
            'Percent', 'Save', 'Package', 'Trash2', 'Edit2', 'AlertTriangle', 'AlertCircle',
            'Settings', 'Wifi', 'Smartphone', 'UserPlus', 'Star', 'Trophy', 'ArrowRightLeft', 
            'Ban', 'Lock', 'LogOut', 'Truck', 'ScanBarcode', 'UserCog', 'Shield',
            'Sparkles', 'Bot', 'Send', 'MessageSquare', 'Clock', 'Timer', 'Bell', 'Key', 'FileText', 'Bluetooth', 'Camera', 'CameraOff', 'QrCode', 'Droplet', 'ChevronRight', 'CircleDollarSign', 'RotateCcw', 'Store', 'HandHelping', 'Database', 'Download', 'Upload', 'Wallet'
        ];

        const Icons = {};
        iconNames.forEach(name => { Icons[name] = (props) => <LucideIconWrapper name={name} {...props} />; });
        const { Monitor, Gamepad2, Play, Pause, Square, Coffee, X, ShoppingBag, Users, Ticket, PlusCircle, CheckCircle, Package, Trash2, Edit2, Settings, Ban, Lock, LogOut, Truck, ScanBarcode, UserCog, Shield, Sparkles, Bot, Send, Clock, Timer, Bell, Trophy, ArrowRightLeft, Key, Save, Printer, FileText, Bluetooth, Camera, CameraOff, QrCode, Droplet, ChevronRight, CircleDollarSign, RotateCcw, Store, Wifi, HandHelping, UserPlus, Database, Download, Upload, AlertTriangle, Wallet } = Icons;

        // --- CONSTANTES ---
        const EMPRESA = "Ciber Centro Progreso";
        const SISTEMA = "v2.1";
        const COLOR_CORP = "bg-slate-900"; 
        const RATIO_PUNTOS = 10; // $1 peso = 10 puntos

        // --- CONFIGURACION SERVICIOS ---
        const PRECIOS_IMPRESION = {
            'IMPRESION_BN': { 'B': 2.00, 'M': 5.00, 'G': 8.00 },
            'IMPRESION_COLOR': { 'B': 3.00, 'M': 7.00, 'G': 12.00 }
        };
        const MODIFICADOR_TAMANO = {
            'CARTA': { op: 'add', val: 0 },
            'OFICIO': { op: 'add', val: 1 },
            'TABLOIDE': { op: 'mult', val: 2 }
        };
        const OTROS_SERVICIOS = {
            'ESCANEO': { 'CARTA': 4, 'OFICIO': 5 },
            'ENVIO': { 'GENERAL': 5 },
            'WIFI': { 'GENERAL': 10 },
            'ASESORIA': { 'GENERAL': 15 }
        };

        // --- DATOS INICIALES ---
        const USUARIOS_DEFAULT = [
            { id: 1, nombre: 'Administrador', pin: '1234', rol: 'admin' },
            { id: 2, nombre: 'Empleado Turno 1', pin: '0000', rol: 'empleado' }
        ];
        const CLIENTES_INICIALES = [{ id: 1, nombre: 'Cliente General', puntos: 0, cupones: [] }];
        const EQUIPOS_INICIALES = [
            { id: 1, tipo: 'PC', nombre: 'Estaci√≥n 01', estado: 'libre', precioHora: 15.00 },
            { id: 2, tipo: 'PC', nombre: 'Estaci√≥n 02', estado: 'libre', precioHora: 15.00 },
            { id: 3, tipo: 'PC', nombre: 'Estaci√≥n 03', estado: 'libre', precioHora: 15.00 },
            { id: 4, tipo: 'PC', nombre: 'Estaci√≥n 04', estado: 'libre', precioHora: 15.00 },
            { id: 5, tipo: 'CONSOLA', nombre: 'Xbox Series S', estado: 'libre', precioHora: 20.00 },
            { id: 6, tipo: 'CONSOLA', nombre: 'PlayStation 5', estado: 'libre', precioHora: 20.00 },
        ];
        const PRODUCTOS_BASE_DEFAULT = [
            { id: 1, nombre: 'Coca Cola 600ml', precio: 18.00, icon: 'ü•§', stock: 24, categoria: 'Bebidas', codigo: '7501055300075' },
            { id: 2, nombre: 'Papas Sabritas', precio: 16.00, icon: 'üçü', stock: 15, categoria: 'Snacks', codigo: '7501011123456' },
        ];
        const CONFIG_INICIAL = {
            tarifaMinima: 5.00,
            formatoTicket: '58mm' // '58mm' o 'LETTER'
        };

        // --- COMPONENTE LOGIN ---
        const LoginScreen = ({ onLogin, usuarios }) => {
            const [pin, setPin] = useState('');
            const [error, setError] = useState(false);

            const handleNum = (num) => { 
                if (pin.length < 4) setPin(prev => prev + num); 
                setError(false); 
            };
            const handleClear = () => { setPin(''); setError(false); };
            const handleSubmit = () => {
                const user = usuarios.find(u => u.pin === pin);
                if (user) onLogin(user);
                else { setError(true); setPin(''); setTimeout(() => setError(false), 1000); }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') handleSubmit();
            };

            return (
                <div className="fixed inset-0 bg-slate-900 flex items-center justify-center z-[100]">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm modal-anim">
                        <div className="text-center mb-6">
                            <div className="bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <Lock className="text-slate-700" size={32} />
                            </div>
                            <h2 className="text-2xl font-bold text-slate-800">{EMPRESA}</h2>
                            <p className="text-slate-400 text-sm">Sistema de Control</p>
                        </div>
                        
                        <div className="mb-6">
                            <input 
                                type="password" 
                                value={pin} 
                                onChange={(e) => {
                                    if(e.target.value.length <= 4 && /^\d*$/.test(e.target.value)) setPin(e.target.value);
                                    setError(false);
                                }}
                                onKeyDown={handleKeyDown}
                                className={`w-full text-center text-3xl tracking-[1em] border-b-2 py-2 focus:outline-none focus:border-indigo-600 bg-transparent transition-all ${error ? 'border-rose-500 text-rose-500' : 'border-slate-300 text-slate-800'}`}
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                autoFocus
                            />
                        </div>

                        <div className="grid grid-cols-3 gap-4 mb-4">
                            {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => (
                                <button key={n} onClick={() => handleNum(n)} className="h-14 rounded-xl bg-slate-50 border-b-4 border-slate-200 active:border-b-0 active:translate-y-1 font-bold text-xl text-slate-700 hover:bg-slate-100 transition-all">{n}</button>
                            ))}
                            <button onClick={handleClear} className="h-14 rounded-xl bg-rose-50 text-rose-600 font-bold border-b-4 border-rose-100 active:border-b-0 active:translate-y-1 hover:bg-rose-100">C</button>
                            <button onClick={() => handleNum(0)} className="h-14 rounded-xl bg-slate-50 border-b-4 border-slate-200 active:border-b-0 active:translate-y-1 font-bold text-xl text-slate-700 hover:bg-slate-100">{0}</button>
                            <button onClick={handleSubmit} className="h-14 rounded-xl bg-indigo-600 text-white font-bold border-b-4 border-indigo-800 active:border-b-0 active:translate-y-1 hover:bg-indigo-700 flex justify-center items-center"><ArrowRightLeft size={20} /></button>
                        </div>
                        {error && <p className="text-center text-rose-500 text-sm font-bold animate-pulse">PIN Incorrecto</p>}
                    </div>
                </div>
            );
        };

        // --- COMPONENTE PRINCIPAL ---
        function CiberManager() {
            // STATES
            const [usuarioActual, setUsuarioActual] = useState(null);
            const [usuarios, setUsuarios] = useState(() => JSON.parse(localStorage.getItem('sys-usuarios')) || USUARIOS_DEFAULT);
            const [equipos, setEquipos] = useState(() => {
                const s = localStorage.getItem('sys-equipos');
                return s ? JSON.parse(s) : EQUIPOS_INICIALES.map(e => ({ ...e, inicio: null, tiempoAcumulado: 0, cuenta: [], modo: 'libre', limiteTiempo: 0, alertaMinuto: false }));
            });
            const [catalogo, setCatalogo] = useState(() => JSON.parse(localStorage.getItem('sys-catalogo')) || PRODUCTOS_BASE_DEFAULT);
            const [ventas, setVentas] = useState(() => JSON.parse(localStorage.getItem('sys-ventas')) || []);
            const [clientes, setClientes] = useState(() => JSON.parse(localStorage.getItem('sys-clientes')) || CLIENTES_INICIALES);
            
            // CONFIG Y CAJA
            const [config, setConfig] = useState(() => JSON.parse(localStorage.getItem('sys-config')) || CONFIG_INICIAL);
            const [caja, setCaja] = useState(() => JSON.parse(localStorage.getItem('sys-caja')) || { activa: false, fondo: 0, inicio: null });

            // NUEVO STATE: CARRITO DE VENTA DIRECTA
            const [carritoDirecto, setCarritoDirecto] = useState([]);
            const [ventaDirectaClienteId, setVentaDirectaClienteId] = useState(1);
            const [mostrarNuevoCliente, setMostrarNuevoCliente] = useState(false);
            const [nuevoClienteNombre, setNuevoClienteNombre] = useState('');
            const [pagoConDirecto, setPagoConDirecto] = useState(''); 
            
            // UI Modals
            const [modalAbierto, setModalAbierto] = useState(null); 
            const [equipoSeleccionadoId, setEquipoSeleccionadoId] = useState(null); 
            const [confirmarResetId, setConfirmarResetId] = useState(null); 
            const [checkoutData, setCheckoutData] = useState({ clienteId: 1, pagoCon: '' }); 
            const [prepagoData, setPrepagoData] = useState({ dinero: '', minutos: '' });
            const [pinData, setPinData] = useState({ nuevo: '', confirmar: '' });
            const [cajaForm, setCajaForm] = useState({ fondo: '' }); // Formulario para abrir caja
            const [showCamera, setShowCamera] = useState(false); 
            
            // Estado para servicios (Impresiones, etc)
            const [servicioForm, setServicioForm] = useState({ tipo: 'IMPRESION_BN', tamano: 'CARTA', cobertura: 'B', cantidad: 1 });
            const [manualItemForm, setManualItemForm] = useState({ nombre: '', precio: '' });

            // Chat AI
            const [chatAbierto, setChatAbierto] = useState(false);
            const [mensajesChat, setMensajesChat] = useState([{ role: 'model', text: '¬°Hola! Soy tu Asistente T√©cnico Virtual. ü§ñ Puedo ayudarte con dudas sobre precios, internet lento, impresoras, etc. ¬øEn qu√© te ayudo?' }]);
            const [inputChat, setInputChat] = useState('');
            const [cargandoAI, setCargandoAI] = useState(false);
            const chatEndRef = useRef(null);

            // Forms
            const [itemForm, setItemForm] = useState({ id: null, nombre: '', precio: '', stock: '', categoria: 'General', codigo: '' });
            const [usuarioForm, setUsuarioForm] = useState({ nombre: '', pin: '', rol: 'empleado' });
            const [clienteForm, setClienteForm] = useState({ nombre: '' });
            const [estacionForm, setEstacionForm] = useState({ id: null, nombre: '', tipo: 'PC', precioHora: '' });

            // Buffer Scanner
            const barcodeBuffer = useRef('');
            const lastKeyTime = useRef(0);
            const html5QrCodeRef = useRef(null);

            // --- EFFECTS ---
            useEffect(() => {
                localStorage.setItem('sys-equipos', JSON.stringify(equipos));
                localStorage.setItem('sys-ventas', JSON.stringify(ventas));
                localStorage.setItem('sys-catalogo', JSON.stringify(catalogo));
                localStorage.setItem('sys-clientes', JSON.stringify(clientes));
                localStorage.setItem('sys-usuarios', JSON.stringify(usuarios));
                localStorage.setItem('sys-config', JSON.stringify(config));
                localStorage.setItem('sys-caja', JSON.stringify(caja));
            }, [equipos, ventas, catalogo, clientes, usuarios, config, caja]);

            // SEGURIDAD
            useEffect(() => {
                if (usuarioActual && usuarioActual.id === 1 && usuarioActual.pin === '1234' && modalAbierto !== 'cambiar_pin') {
                    setTimeout(() => {
                        alert("‚ö†Ô∏è ADVERTENCIA DE SEGURIDAD\n\nEst√°s utilizando la contrase√±a predeterminada (1234).\nPor favor, c√°mbiala ahora.");
                        setModalAbierto('cambiar_pin');
                    }, 500);
                }
            }, [usuarioActual]);

            // TIMER LOOP
            useEffect(() => {
                const interval = setInterval(() => {
                    setEquipos(prev => prev.map(eq => {
                        if (eq.estado === 'ocupado' && eq.inicio) {
                            const tiempoTranscurrido = eq.tiempoAcumulado + (Date.now() - eq.inicio);
                            let newState = { ...eq, _tick: Date.now() };

                            if (eq.modo === 'prepago' && eq.limiteTiempo > 0) {
                                const restante = eq.limiteTiempo - tiempoTranscurrido;
                                if (restante <= 60000 && restante > 0 && !eq.alertaMinuto) {
                                    playSound('warning');
                                    newState.alertaMinuto = true;
                                }
                                if (restante <= 0) {
                                    playSound('alarm');
                                    newState.estado = 'finalizado'; 
                                    newState.inicio = null;
                                    newState.tiempoAcumulado = eq.limiteTiempo;
                                    newState.alertaMinuto = false;
                                }
                            }
                            return newState;
                        }
                        return eq;
                    }));
                }, 1000);
                return () => clearInterval(interval);
            }, []);

            useEffect(() => { if (chatAbierto && chatEndRef.current) chatEndRef.current.scrollIntoView({ behavior: 'smooth' }); }, [mensajesChat, chatAbierto]);

            // --- CAMERA ---
            useEffect(() => {
                if (showCamera && (modalAbierto === 'inventario')) {
                    const startCamera = async () => {
                        try {
                            const Html5Qrcode = window.Html5Qrcode;
                            if(!Html5Qrcode) return alert("Librer√≠a QR no cargada");
                            const html5QrCode = new Html5Qrcode("reader");
                            html5QrCodeRef.current = html5QrCode;
                            await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, (t, r) => handleBarcodeScan(t), (e) => {});
                        } catch (err) { alert("Error al iniciar c√°mara: " + err); setShowCamera(false); }
                    };
                    setTimeout(startCamera, 100);
                } else { stopCamera(); }
                return () => stopCamera();
            }, [showCamera, modalAbierto]);

            const stopCamera = async () => {
                if (html5QrCodeRef.current) {
                    try { await html5QrCodeRef.current.stop(); html5QrCodeRef.current.clear(); } catch(e) {}
                    html5QrCodeRef.current = null;
                }
            };

            // --- AI SIMULADA ---
            const enviarMensajeIA = async () => {
                if(!inputChat.trim()) return;
                const textoUsuario = inputChat;
                setMensajesChat(prev => [...prev, { role: 'user', text: textoUsuario }]);
                setInputChat('');
                setCargandoAI(true);
                
                setTimeout(() => {
                    let respuesta = "Disculpa, no entend√≠ tu pregunta. Intenta con palabras clave como 'precio', 'internet', 'impresora' o 'corte'.";
                    const q = textoUsuario.toLowerCase();
                    
                    if (q.includes('hola') || q.includes('buen')) respuesta = "¬°Hola! ¬øEn qu√© puedo apoyarte hoy en el Ciber?";
                    else if (q.includes('precio') || q.includes('cuanto') || q.includes('costo')) respuesta = "Precios actuales:\n- Renta PC: $15/hr\n- Consolas: $20/hr\n- Impresiones B/N: $2\n- Color: $3+";
                    else if (q.includes('lento') || q.includes('internet') || q.includes('wifi')) respuesta = "Si el internet est√° lento:\n1. Reinicia el m√≥dem (espera 10 seg).\n2. Verifica si alguien est√° descargando archivos grandes.\n3. Checa los cables de red.";
                    else if (q.includes('impresora') || q.includes('atorada') || q.includes('tinta')) respuesta = "Problemas de impresi√≥n:\n- Revisa si hay papel.\n- Verifica si hay papel atorado.\n- Checa los niveles de tinta en el panel de la impresora.";
                    else if (q.includes('corte') || q.includes('caja') || q.includes('dinero')) respuesta = "Para hacer corte de caja, utiliza el bot√≥n de 'Caja' (icono de billete) en la barra superior. Podr√°s ver las ventas del turno actual.";
                    else if (q.includes('ticket') || q.includes('formato')) respuesta = "Puedes cambiar el formato del ticket (T√©rmico/Carta) en el bot√≥n de Configuraci√≥n (engranaje) en la parte superior.";
                    else if (q.includes('gracias')) respuesta = "¬°De nada! Estoy para servirte.";

                    setMensajesChat(prev => [...prev, { role: 'model', text: respuesta }]);
                    setCargandoAI(false);
                }, 800);
            };

            // --- BARCODE ---
            useEffect(() => {
                const handleKeyDown = (e) => {
                    const currentTime = Date.now();
                    if (currentTime - lastKeyTime.current > 100) barcodeBuffer.current = '';
                    lastKeyTime.current = currentTime;
                    if (e.key === 'Enter') {
                        if (barcodeBuffer.current.length > 0) { handleBarcodeScan(barcodeBuffer.current); barcodeBuffer.current = ''; }
                    } else if (e.key.length === 1 && document.activeElement.tagName !== 'INPUT') { barcodeBuffer.current += e.key; }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [modalAbierto, catalogo, carritoDirecto]);

            const handleBarcodeScan = (code) => {
                playSound('scan');
                if (modalAbierto === 'productos' || modalAbierto === 'venta_directa') {
                    const producto = catalogo.find(p => p.codigo === code);
                    if (producto && producto.stock > 0) {
                        if (modalAbierto === 'venta_directa') {
                            agregarProductoDirecto(producto);
                        } else {
                            agregarProductoACuenta(producto, false);
                        }
                    }
                    else alert(producto ? "¬°Sin stock!" : "Producto no encontrado.");
                } else if (modalAbierto === 'inventario') {
                    const producto = catalogo.find(p => p.codigo === code);
                    if (producto) setItemForm(producto);
                    else {
                        setItemForm({ id: null, nombre: '', precio: '', stock: '', categoria: 'General', codigo: code, icon: 'üì¶' });
                        playSound('warning');
                    }
                }
            };

            // --- HELPERS ---
            const getEquipoActual = () => equipos.find(e => e.id === equipoSeleccionadoId) || { nombre: 'Desconocido', cuenta: [] };
            const calcularTiempo = (eq) => {
                if (!eq || eq.estado === 'libre') return 0;
                let t = eq.tiempoAcumulado;
                if (eq.estado === 'ocupado' && eq.inicio) t += (Date.now() - eq.inicio);
                return t;
            };

            // --- CALCULO DE RENTA CON MINIMO ---
            const calcularTotalRenta = (eq) => {
                if (!eq || eq.tipo === 'DIRECTA') return 0;
                const tiempoMs = eq.estado === 'finalizado' ? eq.tiempoAcumulado : calcularTiempo(eq);
                const horas = tiempoMs / 3600000;
                const tarifa = parseFloat(eq.precioHora);
                let total = horas * tarifa;
                
                // Aplicar tarifa m√≠nima si hay uso significativo (m√°s de 1 min) pero costo menor al m√≠nimo
                if (tiempoMs > 60000 && total < config.tarifaMinima) {
                    return config.tarifaMinima;
                }
                
                return Math.max(total, 0);
            };

            // --- GESTI√ìN CAJA ---
            const abrirCaja = () => {
                if (!cajaForm.fondo) return alert("Ingresa un fondo inicial");
                setCaja({ activa: true, fondo: parseFloat(cajaForm.fondo), inicio: new Date().toISOString() });
                setCajaForm({ fondo: '' });
                alert("Turno iniciado correctamente.");
            };

            const cerrarCaja = () => {
                if(confirm("¬øSeguro que deseas cerrar el turno y hacer corte? Se generar√° el reporte PDF.")) {
                    const ventasTurno = obtenerVentasTurno();
                    generarReporteCaja(caja, ventasTurno); // Generar PDF Carta
                    
                    setCaja({ activa: false, fondo: 0, inicio: null });
                    alert("Turno cerrado. Reporte generado.");
                    setModalAbierto(null);
                }
            };

            const obtenerVentasTurno = () => {
                if (!caja.inicio) return [];
                return ventas.filter(v => new Date(v.fecha) >= new Date(caja.inicio));
            };

            // --- GESTI√ìN ESTACIONES (CRUD) ---
            const guardarEstacion = () => {
                if (!estacionForm.nombre || !estacionForm.precioHora) return alert("Faltan datos");
                const nueva = {
                    id: estacionForm.id || Date.now(),
                    nombre: estacionForm.nombre,
                    tipo: estacionForm.tipo,
                    precioHora: parseFloat(estacionForm.precioHora),
                    estado: 'libre', inicio: null, tiempoAcumulado: 0, cuenta: [], modo: 'libre', limiteTiempo: 0, alertaMinuto: false
                };
                if (estacionForm.id) {
                    setEquipos(prev => prev.map(e => e.id === estacionForm.id ? { ...e, nombre: estacionForm.nombre, tipo: estacionForm.tipo, precioHora: parseFloat(estacionForm.precioHora) } : e));
                } else {
                    setEquipos(prev => [...prev, nueva]);
                }
                setEstacionForm({ id: null, nombre: '', tipo: 'PC', precioHora: '' });
            };

            const eliminarEstacion = (id) => {
                if(confirm("¬øEliminar estaci√≥n? Se perder√°n los datos actuales.")) setEquipos(prev => prev.filter(e => e.id !== id));
            };

            const prepararEdicionEstacion = (est) => setEstacionForm(est);

            // --- GESTI√ìN INVENTARIO ---
            const guardarProductoInventario = () => {
                if (!itemForm.nombre || !itemForm.precio) return alert("Faltan datos");
                const nuevo = { ...itemForm, id: itemForm.id || Date.now(), precio: parseFloat(itemForm.precio), stock: parseInt(itemForm.stock) || 0, icon: itemForm.categoria === 'Bebidas' ? 'ü•§' : 'üì¶' };
                if (itemForm.id) setCatalogo(prev => prev.map(p => p.id === itemForm.id ? { ...p, ...nuevo } : p));
                else setCatalogo(prev => [...prev, nuevo]);
                setItemForm({ id: null, nombre: '', precio: '', stock: '', categoria: 'General', codigo: '' });
                if(showCamera) playSound('success');
            };
            const eliminarProductoInventario = (id) => { if(confirm("¬øEliminar?")) setCatalogo(prev => prev.filter(p => p.id !== id)); };
            const prepararEdicionProducto = (prod) => setItemForm(prod);
            
			// --- HELPER: NUMERO A LETRAS ---
        const numeroALetras = (amount) => {
            const Unidades = num => ["", "UN ", "DOS ", "TRES ", "CUATRO ", "CINCO ", "SEIS ", "SIETE ", "OCHO ", "NUEVE "][num];
            const Decenas = num => {
                const dec = Math.floor(num / 10);
                const uni = num - (dec * 10);
                switch (dec) {
                    case 1: return uni < 6 ? ["DIEZ ", "ONCE ", "DOCE ", "TRECE ", "CATORCE ", "QUINCE "][uni] : "DIECI" + Unidades(uni);
                    case 2: return uni === 0 ? "VEINTE " : "VEINTI" + Unidades(uni);
                    case 3: return Unidades(uni) ? "TREINTA Y " + Unidades(uni) : "TREINTA ";
                    case 4: return Unidades(uni) ? "CUARENTA Y " + Unidades(uni) : "CUARENTA ";
                    case 5: return Unidades(uni) ? "CINCUENTA Y " + Unidades(uni) : "CINCUENTA ";
                    case 6: return Unidades(uni) ? "SESENTA Y " + Unidades(uni) : "SESENTA ";
                    case 7: return Unidades(uni) ? "SETENTA Y " + Unidades(uni) : "SETENTA ";
                    case 8: return Unidades(uni) ? "OCHENTA Y " + Unidades(uni) : "OCHENTA ";
                    case 9: return Unidades(uni) ? "NOVENTA Y " + Unidades(uni) : "NOVENTA ";
                    case 0: return Unidades(uni);
                }
            };
            const Centenas = num => {
                const cen = Math.floor(num / 100);
                const resto = num - (cen * 100);
                if (cen === 1) return resto > 0 ? "CIENTO " + Decenas(resto) : "CIEN ";
                return ["", "CIENTO ", "DOSCIENTOS ", "TRESCIENTOS ", "CUATROCIENTOS ", "QUINIENTOS ", "SEISCIENTOS ", "SETECIENTOS ", "OCHOCIENTOS ", "NOVECIENTOS "][cen] + Decenas(resto);
            };

            const pesos = Math.floor(amount);
            const centavos = Math.round((amount - pesos) * 100);
            let letras = "";

            if (pesos === 0) letras = "CERO ";
            else if (pesos < 100) letras = Decenas(pesos);
            else if (pesos < 1000) letras = Centenas(pesos);
            else if (pesos < 2000) letras = "MIL " + Centenas(pesos % 1000);
            else if (pesos < 1000000) letras = Centenas(Math.floor(pesos / 1000)) + " MIL " + Centenas(pesos % 1000);

            return `${letras.trim()} PESOS ${centavos.toString().padStart(2, '0')}/100 M.N.`;
        };

            // --- LOGICA VENTA DIRECTA (MOSTRADOR) ---
            const abrirVentaDirecta = () => {
                setCarritoDirecto([]);
                setServicioForm({ tipo: 'IMPRESION_BN', tamano: 'CARTA', cobertura: 'B', cantidad: 1 });
                setVentaDirectaClienteId(1); 
                setMostrarNuevoCliente(false);
                setPagoConDirecto(''); // Reset pagoCon
                setModalAbierto('venta_directa');
            };

            const agregarProductoDirecto = (prod) => {
                setCarritoDirecto(prev => [...prev, { uid: Date.now(), idCatalogo: prod.id, nombre: prod.nombre, precio: parseFloat(prod.precio), cantidad: 1 }]);
                playSound('scan');
            };

            const agregarServicioDirecto = () => {
                 const { tipo, tamano, cobertura, cantidad } = servicioForm;
                let precioUnitario = 0;
                let nombreServicio = '';
                if (tipo === 'ENVIO') { precioUnitario = OTROS_SERVICIOS['ENVIO']['GENERAL']; nombreServicio = `Env√≠o Digital`; } 
                else if (tipo === 'ESCANEO') { precioUnitario = OTROS_SERVICIOS['ESCANEO'][tamano]; nombreServicio = `Escaneo ${tamano}`; }
                else if (tipo === 'WIFI') { precioUnitario = OTROS_SERVICIOS['WIFI']['GENERAL']; nombreServicio = 'Acceso WiFi (Dispositivo)'; }
                else if (tipo === 'ASESORIA') { precioUnitario = OTROS_SERVICIOS['ASESORIA']['GENERAL']; nombreServicio = 'Asesor√≠a / Apoyo T√©cnico'; }
                else {
                    const base = PRECIOS_IMPRESION[tipo][cobertura];
                    const mod = MODIFICADOR_TAMANO[tamano];
                    precioUnitario = mod.op === 'add' ? base + mod.val : base * mod.val;
                    nombreServicio = `${tipo === 'IMPRESION_BN' ? 'Imp. B/N' : 'Imp. Color'} ${tamano} (${cobertura})`;
                }
                if (cantidad > 10 && tipo !== 'WIFI' && tipo !== 'ASESORIA') precioUnitario *= 0.90;
                
                setCarritoDirecto(prev => [...prev, { uid: Date.now(), idCatalogo: null, nombre: nombreServicio + (cantidad > 10 ? ' (-10%)' : ''), precio: parseFloat(precioUnitario), cantidad: parseInt(cantidad) || 1 }]);
                setServicioForm({ ...servicioForm, cantidad: 1 });
                playSound('success');
            };

            const agregarManualDirecto = () => {
                if(!manualItemForm.nombre || !manualItemForm.precio) return;
                setCarritoDirecto(prev => [...prev, { uid: Date.now(), idCatalogo: null, nombre: manualItemForm.nombre + ' (Manual)', precio: parseFloat(manualItemForm.precio), cantidad: 1, esManual: true }]);
                setManualItemForm({nombre: '', precio: ''});
                playSound('success');
            };

            const agregarClienteRapido = () => {
                if(!nuevoClienteNombre.trim()) return alert("Nombre vac√≠o");
                const nuevo = { id: Date.now(), nombre: nuevoClienteNombre, puntos: 0 };
                setClientes(prev => [...prev, nuevo]);
                setVentaDirectaClienteId(nuevo.id);
                setNuevoClienteNombre('');
                setMostrarNuevoCliente(false);
                alert("Cliente registrado y seleccionado.");
            };

            const eliminarItemDirecto = (uid) => {
                setCarritoDirecto(prev => prev.filter(i => i.uid !== uid));
            };

            const cobrarVentaDirecta = () => {
                if (carritoDirecto.length === 0) return alert("El carrito est√° vac√≠o.");
                
                const total = carritoDirecto.reduce((a, i) => a + (i.precio * (i.cantidad || 1)), 0);
                const pagoCon = parseFloat(pagoConDirecto) || 0;
                const cambio = pagoCon - total;

                const cliente = clientes.find(c => c.id === parseInt(ventaDirectaClienteId)) || { id: 1, nombre: 'P√∫blico General', puntos: 0 };
                let puntosGanados = 0;
                
                if (cliente.id !== 1) { 
                    puntosGanados = Math.floor(total * RATIO_PUNTOS);
                    setClientes(prev => prev.map(c => c.id === cliente.id ? { ...c, puntos: (c.puntos || 0) + puntosGanados } : c));
                    if(puntosGanados > 0) alert(`üéâ ¬°${cliente.nombre} gan√≥ ${puntosGanados} Puntos!`);
                }
                
                const nCat = [...catalogo];
                carritoDirecto.forEach(i => { if (i.idCatalogo) { const idx = nCat.findIndex(p => p.id === i.idCatalogo); if (idx !== -1) nCat[idx].stock = Math.max(0, nCat[idx].stock - 1); } });
                setCatalogo(nCat);

                const venta = { 
                    id: Date.now(), 
                    fecha: new Date().toISOString(), 
                    equipo: "Mostrador", 
                    cliente: cliente.nombre, 
                    total, 
                    puntosGanados, 
                    productos: carritoDirecto, 
                    subtotalRenta: 0,
                    pagoCon: pagoCon, 
                    cambio: cambio,
                    atendio: usuarioActual.nombre 
                };
                
                setVentas(prev => [...prev, venta]);
                generarTicket(venta, config.formatoTicket || '58mm'); // Usar formato configurado
                playSound('success');
                setModalAbierto(null);
                setCarritoDirecto([]);
                setPagoConDirecto('');
            };

            // --- FUNCIONES EXPORTAR / IMPORTAR ---
            const handleExport = () => {
                const data = {
                    equipos, ventas, catalogo, clientes, usuarios, config, caja
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sysquantic_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                alert("‚úÖ Respaldo descargado correctamente. Guarde este archivo en un lugar seguro.");
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (Array.isArray(data.equipos) && Array.isArray(data.catalogo) && Array.isArray(data.clientes)) {
                            if(confirm("‚ö†Ô∏è ADVERTENCIA: Esto borrar√° los datos actuales y cargar√° el respaldo. ¬øContinuar?")) {
                                localStorage.setItem('sys-equipos', JSON.stringify(data.equipos));
                                localStorage.setItem('sys-ventas', JSON.stringify(data.ventas || []));
                                localStorage.setItem('sys-catalogo', JSON.stringify(data.catalogo));
                                localStorage.setItem('sys-clientes', JSON.stringify(data.clientes));
                                if(data.usuarios) localStorage.setItem('sys-usuarios', JSON.stringify(data.usuarios));
                                if(data.config) localStorage.setItem('sys-config', JSON.stringify(data.config));
                                if(data.caja) localStorage.setItem('sys-caja', JSON.stringify(data.caja));
                                
                                alert("‚úÖ Datos importados correctamente. El sistema se reiniciar√° para aplicar cambios.");
                                window.location.reload();
                            }
                        } else {
                            alert("‚ùå Error: El archivo no tiene el formato v√°lido de SysQuantic.");
                        }
                    } catch (err) {
                        alert("‚ùå Error al leer el archivo: " + err);
                    }
                };
                reader.readAsText(file);
            };

            // --- SERVICIOS ESTACIONES ---
            const agregarProductoACuenta = (prod) => {
                 setEquipos(prev => prev.map(eq => {
                    if (eq.id === equipoSeleccionadoId) return { ...eq, cuenta: [...eq.cuenta, { uid: Date.now(), idCatalogo: prod.id, nombre: prod.nombre, precio: parseFloat(prod.precio), cantidad: 1 }] };
                    return eq;
                 }));
            };
            
            const agregarManualACuenta = () => {
                if(!manualItemForm.nombre || !manualItemForm.precio) return;
                setEquipos(prev => prev.map(eq => {
                    if (eq.id === equipoSeleccionadoId) return { ...eq, cuenta: [...eq.cuenta, { uid: Date.now(), idCatalogo: null, nombre: manualItemForm.nombre + ' (Manual)', precio: parseFloat(manualItemForm.precio), cantidad: 1, esManual: true }] };
                    return eq;
                }));
                setManualItemForm({nombre: '', precio: ''});
                playSound('success');
            };

            const agregarServicioACuenta = () => {
                const { tipo, tamano, cobertura, cantidad } = servicioForm;
                let precioUnitario = 0;
                let nombreServicio = '';
                if (tipo === 'ENVIO') { precioUnitario = OTROS_SERVICIOS['ENVIO']['GENERAL']; nombreServicio = `Env√≠o Digital`; } 
                else if (tipo === 'ESCANEO') { precioUnitario = OTROS_SERVICIOS['ESCANEO'][tamano]; nombreServicio = `Escaneo ${tamano}`; } 
                else if (tipo === 'WIFI') { precioUnitario = OTROS_SERVICIOS['WIFI']['GENERAL']; nombreServicio = 'Acceso WiFi (Dispositivo)'; }
                else if (tipo === 'ASESORIA') { precioUnitario = OTROS_SERVICIOS['ASESORIA']['GENERAL']; nombreServicio = 'Asesor√≠a / Apoyo T√©cnico'; }
                else {
                    const base = PRECIOS_IMPRESION[tipo][cobertura];
                    const mod = MODIFICADOR_TAMANO[tamano];
                    precioUnitario = mod.op === 'add' ? base + mod.val : base * mod.val;
                    nombreServicio = `${tipo === 'IMPRESION_BN' ? 'Imp. B/N' : 'Imp. Color'} ${tamano} (${cobertura})`;
                }
                if (cantidad > 10 && tipo !== 'WIFI' && tipo !== 'ASESORIA') precioUnitario *= 0.90;
                setEquipos(prev => prev.map(eq => {
                    if (eq.id === equipoSeleccionadoId) return { ...eq, cuenta: [...eq.cuenta, { uid: Date.now(), idCatalogo: null, nombre: nombreServicio + (cantidad > 10 ? ' (-10%)' : ''), precio: parseFloat(precioUnitario), cantidad: parseInt(cantidad) || 1 }] };
                    return eq;
                }));
                setServicioForm({ ...servicioForm, cantidad: 1 });
            };
            const eliminarProductoDeCuenta = (uid) => { setEquipos(prev => prev.map(e => e.id === equipoSeleccionadoId ? { ...e, cuenta: e.cuenta.filter(i => i.uid !== uid) } : e)); };

            // --- ACCIONES ---
            const iniciarTiempoLibre = (id) => { setEquipos(prev => prev.map(eq => eq.id === id ? { ...eq, estado: 'ocupado', inicio: Date.now(), modo: 'libre', limiteTiempo: 0, alertaMinuto: false } : eq)); };
            const togglePausa = (id) => {
                setEquipos(prev => prev.map(eq => {
                    if (eq.id === id) {
                        if (eq.estado === 'ocupado') return { ...eq, estado: 'pausado', tiempoAcumulado: eq.tiempoAcumulado + (Date.now() - eq.inicio), inicio: null };
                        if (eq.estado === 'pausado') return { ...eq, estado: 'ocupado', inicio: Date.now() };
                    }
                    return eq;
                }));
            };
            const abrirPrepago = (id) => { setEquipoSeleccionadoId(id); setPrepagoData({ dinero: '', minutos: '' }); setModalAbierto('prepago'); };
            const aplicarPrepago = () => {
                const eq = getEquipoActual();
                let ms = 0;
                if (prepagoData.dinero) ms = (parseFloat(prepagoData.dinero) / eq.precioHora) * 3600000;
                else if (prepagoData.minutos) ms = parseInt(prepagoData.minutos) * 60000;
                if (ms > 0) { setEquipos(prev => prev.map(e => e.id === eq.id ? { ...e, estado: 'ocupado', inicio: Date.now(), modo: 'prepago', limiteTiempo: ms, tiempoAcumulado: 0, alertaMinuto: false } : e)); setModalAbierto(null); } 
                else alert("Inv√°lido");
            };
            
            // --- CANCELAR SERVICIO (MODAL) ---
            const cancelarServicio = (id) => {
                setConfirmarResetId(id);
            };

            const ejecutarReset = () => {
                if (confirmarResetId) {
                    setEquipos(prev => prev.map(e => e.id === confirmarResetId ? { ...e, estado: 'libre', inicio: null, tiempoAcumulado: 0, cuenta: [], modo: 'libre', limiteTiempo: 0, alertaMinuto: false } : e));
                    setConfirmarResetId(null);
                    playSound('warning');
                }
            };

            // --- USUARIOS ---
            const guardarUsuario = () => {
                if(!usuarioForm.nombre || !usuarioForm.pin) return alert("Faltan datos");
                setUsuarios(prev => [...prev, { ...usuarioForm, id: Date.now() }]);
                setUsuarioForm({ nombre: '', pin: '', rol: 'empleado' });
            };
            const eliminarUsuario = (id) => { if(id !== 1 && confirm("¬øEliminar?")) setUsuarios(prev => prev.filter(u => u.id !== id)); };
            const actualizarPin = () => {
                if (pinData.nuevo.length !== 4 || pinData.nuevo !== pinData.confirmar) return alert("Error en PIN");
                setUsuarios(prev => prev.map(u => u.id === usuarioActual.id ? { ...u, pin: pinData.nuevo } : u));
                setUsuarioActual(prev => ({ ...prev, pin: pinData.nuevo }));
                alert("Actualizado"); setModalAbierto(null); setPinData({ nuevo: '', confirmar: '' });
            };

            // --- INTERCAMBIO ---
            const iniciarIntercambio = (id) => { setEquipoSeleccionadoId(id); setModalAbierto('intercambio'); };
            const confirmarIntercambio = (idDestino) => {
                setEquipos(prev => {
                    const origen = prev.find(e => e.id === equipoSeleccionadoId);
                    const destino = prev.find(e => e.id === idDestino);
                    if(!origen || !destino) return prev;
                    let tiempo = origen.tiempoAcumulado + ((origen.estado === 'ocupado' && origen.inicio) ? (Date.now() - origen.inicio) : 0);
                    const nuevoDestino = { ...destino, estado: origen.estado === 'pausado'?'pausado':'ocupado', inicio: origen.estado === 'pausado'?null:Date.now(), tiempoAcumulado: tiempo, cuenta: [...origen.cuenta], modo: origen.modo, limiteTiempo: origen.limiteTiempo, alertaMinuto: origen.alertaMinuto };
                    const nuevoOrigen = { ...origen, estado: 'libre', inicio: null, tiempoAcumulado: 0, cuenta: [], modo: 'libre', limiteTiempo: 0, alertaMinuto: false };
                    return prev.map(e => e.id === origen.id ? nuevoOrigen : e.id === destino.id ? nuevoDestino : e);
                });
                setModalAbierto(null);
            };

            // --- COBRO ---
            const procesarCobro = () => {
                const eq = getEquipoActual();
                const subRenta = calcularTotalRenta(eq);
                const subProd = eq.cuenta.reduce((a, i) => a + (i.precio * (i.cantidad || 1)), 0); 
                const total = subRenta + subProd;
                
                // C√°lculo de cambio en Estaci√≥n
                const pagoCon = parseFloat(checkoutData.pagoCon) || 0;
                const cambio = pagoCon - total;

                const cliente = clientes.find(c => c.id === checkoutData.clienteId) || { id: 1, nombre: 'General', puntos: 0 };
                let puntosGanados = 0;
                if (cliente.id !== 1) { 
                    puntosGanados = Math.floor(total * RATIO_PUNTOS);
                    setClientes(prev => prev.map(c => c.id === cliente.id ? { ...c, puntos: (c.puntos || 0) + puntosGanados } : c));
                    if(puntosGanados > 0) alert(`üéâ ¬°${cliente.nombre} gan√≥ ${puntosGanados} Puntos!`);
                }
                const nCat = [...catalogo];
                eq.cuenta.forEach(i => { if (i.idCatalogo) { const idx = nCat.findIndex(p => p.id === i.idCatalogo); if (idx !== -1) nCat[idx].stock = Math.max(0, nCat[idx].stock - 1); } });
                setCatalogo(nCat);
                const venta = { 
                    id: Date.now(), 
                    fecha: new Date().toISOString(), 
                    equipo: eq.nombre, 
                    cliente: cliente.nombre, 
                    total, 
                    puntosGanados, 
                    productos: eq.cuenta, 
                    subtotalRenta: subRenta,
                    pagoCon: pagoCon, 
                    cambio: cambio,
                    atendio: usuarioActual.nombre 
                };
                setVentas(prev => [...prev, venta]);
                setEquipos(prev => prev.map(e => e.id === eq.id ? { ...e, estado: 'libre', inicio: null, tiempoAcumulado: 0, cuenta: [], modo: 'libre', limiteTiempo: 0, alertaMinuto: false } : e));
                setModalAbierto(null);
                setCheckoutData({ clienteId: 1, pagoCon: '' }); // Reset
                generarTicket(venta, config.formatoTicket || '58mm'); // Usar formato configurado
                playSound('success');
            };

            // --- REPORTES Y TICKETS (L√ìGICA ACTUALIZADA FISCAL) ---
            const generarTicket = (venta, formato = '58mm') => {
                if (!window.jspdf) return alert("Error PDF");
                try {
                    const { jsPDF } = window.jspdf;
                    
                    // C√°lculos Fiscales (Desglosar IVA del Total)
                    // Total = Base * 1.16  =>  Base = Total / 1.16
                    const total = venta.total;
                    const subtotalBase = total / 1.16;
                    const iva = total - subtotalBase;
                    const totalLetras = numeroALetras(total);

                    // Formato de Fecha dd-mm-aaaa
                    const dateObj = new Date(venta.fecha);
                    const dia = String(dateObj.getDate()).padStart(2, '0');
                    const mes = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const anio = dateObj.getFullYear();
                    const fechaFormat = `${dia}-${mes}-${anio}`;
                    const horaFormat = dateObj.toLocaleTimeString();

                    // Folio Simulado UT-XXX (Usando los √∫ltimos digitos del ID para simular secuencia)
                    const folioFiscal = `UT-${String(venta.id).slice(-4)}`;

                    if (formato === 'LETTER') {
                        // --- FORMATO CARTA (Formal) ---
                        const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "letter" });
                        
                        // Encabezado Fiscal
                        doc.setFontSize(14);
                        doc.setFont("helvetica", "bold");
                        doc.text(EMPRESA, 105, 20, { align: 'center' });
                        
                        doc.setFontSize(10);
                        doc.setFont("helvetica", "normal");
                        doc.text(`RFC: ${RFC}`, 105, 26, { align: 'center' });
                        doc.text(REGIMEN, 105, 31, { align: 'center' });
                        doc.text(`Lugar de expedici√≥n: ${DIRECCION}`, 105, 36, { align: 'center' });

                        // Datos de la Operaci√≥n
                        doc.setDrawColor(200);
                        doc.line(10, 42, 206, 42);
                        
                        doc.setFont("helvetica", "bold");
                        doc.text(`Folio: ${folioFiscal}`, 20, 50);
                        doc.setFont("helvetica", "normal");
                        doc.text(`Fecha de expedici√≥n: ${fechaFormat} ${horaFormat}`, 120, 50);
                        doc.text(`Cliente: ${venta.cliente}`, 20, 56);

                        // Tabla de Productos
                        const tableData = [];
                        
                        // Agregar Renta si existe
                        if(venta.subtotalRenta > 0) {
                            tableData.push([
                                '1', 
                                'Renta de Equipo de C√≥mputo/Consola', 
                                `$${venta.subtotalRenta.toFixed(2)}`, 
                                `$${venta.subtotalRenta.toFixed(2)}`
                            ]);
                        }
                        
                        // Agregar Productos
                        venta.productos.forEach(p => {
                            const cantidad = p.cantidad || 1;
                            const importe = cantidad * p.precio;
                            tableData.push([
                                cantidad, 
                                p.nombre, 
                                `$${p.precio.toFixed(2)}`, 
                                `$${importe.toFixed(2)}`
                            ]);
                        });

                        doc.autoTable({
                            startY: 65,
                            head: [['Cant.', 'Desc.', 'P.Unit', 'Imp.']],
                            body: tableData,
                            theme: 'plain',
                            styles: { fontSize: 10, cellPadding: 2 },
                            headStyles: { fillColor: [240, 240, 240], textColor: 20, fontStyle: 'bold', halign: 'center' },
                            columnStyles: {
                                0: { halign: 'center' }, // Cant
                                2: { halign: 'right' },  // Unit
                                3: { halign: 'right' }   // Importe
                            }
                        });

                        const finalY = doc.lastAutoTable.finalY + 10;

                        // Totales y Desglose
                        doc.setFontSize(10);
                        // Total con letra
                        doc.text(`IMPORTE CON LETRA:`, 20, finalY);
                        doc.setFont("helvetica", "bold");
                        doc.text(totalLetras, 20, finalY + 5);

                        // Desglose Num√©rico (Alineado a la derecha)
                        const xValores = 190;
                        const xEtiquetas = 150;

                        doc.setFont("helvetica", "normal");
                        doc.text("Subtotal:", xEtiquetas, finalY, { align: 'right' });
                        doc.text(`$${subtotalBase.toFixed(2)}`, xValores, finalY, { align: 'right' });

                        doc.text("IVA (16%):", xEtiquetas, finalY + 6, { align: 'right' });
                        doc.text(`$${iva.toFixed(2)}`, xValores, finalY + 6, { align: 'right' });

                        doc.setFontSize(12);
                        doc.setFont("helvetica", "bold");
                        doc.text("TOTAL:", xEtiquetas, finalY + 14, { align: 'right' });
                        doc.text(`$${total.toFixed(2)}`, xValores, finalY + 14, { align: 'right' });

                        // Pie de p√°gina
                        doc.setFontSize(8);
                        doc.setFont("helvetica", "italic");
                        doc.text("Este documento es una representaci√≥n impresa de una venta.", 105, 260, { align: 'center' });

                        doc.save(`Factura_${folioFiscal}.pdf`);

                    } else {
                        // --- FORMATO 58MM (T√âRMICO) ---
                        // Calculamos largo din√°mico
                        const linesHeight = 120 + (venta.productos.length * 10);
                        const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: [58, linesHeight] });
                        
                        let y = 5;
                        const centerX = 29;
                        const margin = 2;
                        const rightX = 56;

                        // Encabezado
                        doc.setFont("helvetica", "bold"); 
                        doc.setFontSize(9);
                        doc.text(EMPRESA, centerX, y, { align: 'center', maxWidth: 54 }); 
                        // Ajuste manual de salto de l√≠nea si el nombre es largo
                        y += (doc.getTextDimensions(EMPRESA).h) + 3;

                        doc.setFont("helvetica", "normal");
                        doc.setFontSize(7);
                        doc.text(`RFC: ${RFC}`, centerX, y, { align: 'center' }); y+=4;
                        doc.text(REGIMEN, centerX, y, { align: 'center', maxWidth: 54 }); 
                        y += (doc.getTextDimensions(REGIMEN).h) + 1; // Salto din√°mico
                        
                        doc.text(DIRECCION, centerX, y, { align: 'center', maxWidth: 54 });
                        y += (doc.getTextDimensions(DIRECCION).h) + 3;

                        doc.text("-".repeat(40), margin, y); y+=4;
                        
                        // Datos Ticket
                        doc.text(`Folio: ${folioFiscal}`, margin, y); y+=4;
                        doc.text(`Fecha: ${fechaFormat} ${horaFormat}`, margin, y); y+=4;
                        doc.text(`Cliente: ${venta.cliente.substring(0,25)}`, margin, y); y+=5;

                        // Encabezados Tabla
                        doc.setFont("helvetica", "bold");
                        doc.text("Cant  Desc           Importe", margin, y); y+=4;
                        doc.setFont("helvetica", "normal");
                        doc.text("-".repeat(40), margin, y); y+=4;

                        // Items
                        // Renta
                        if(venta.subtotalRenta > 0) {
                            doc.text(`1   Renta Equipo`, margin, y); 
                            doc.text(`$${venta.subtotalRenta.toFixed(2)}`, rightX, y, { align: 'right' });
                            y+=4;
                        }

                        // Productos
                        venta.productos.forEach(p => {
                            const qty = p.cantidad || 1;
                            const importe = qty * p.precio;
                            const nombre = p.nombre.substring(0, 18); // Truncar nombre
                            
                            doc.text(`${qty}   ${nombre}`, margin, y);
                            doc.text(`$${importe.toFixed(2)}`, rightX, y, { align: 'right' });
                            y+=4;
                        });

                        doc.text("-".repeat(40), margin, y); y+=4;

                        // Desglose Totales
                        doc.setFontSize(7);
                        doc.text("Subtotal:", 35, y, { align: 'right' });
                        doc.text(`$${subtotalBase.toFixed(2)}`, rightX, y, { align: 'right' }); y+=4;

                        doc.text("IVA (16%):", 35, y, { align: 'right' });
                        doc.text(`$${iva.toFixed(2)}`, rightX, y, { align: 'right' }); y+=5;

                        doc.setFontSize(10);
                        doc.setFont("helvetica", "bold");
                        doc.text("TOTAL:", 35, y, { align: 'right' });
                        doc.text(`$${total.toFixed(2)}`, rightX, y, { align: 'right' }); y+=6;

                        // Total en Letras
                        doc.setFontSize(6);
                        doc.setFont("helvetica", "italic");
                        // Dividir texto largo en l√≠neas
                        const splitTitle = doc.splitTextToSize(totalLetras, 54);
                        doc.text(splitTitle, centerX, y, { align: 'center' });
                        y += (splitTitle.length * 3) + 4;

                        doc.setFontSize(7);
                        doc.setFont("helvetica", "normal");
                        doc.text("¬°Gracias por su preferencia!", centerX, y, { align: 'center' });

                        doc.save(`Ticket_${folioFiscal}.pdf`); 
                    }
                } catch(e) { console.error(e); alert("Error generando PDF"); }
            };

            const generarReporteCaja = (cajaInfo, ventasList) => {
                if (!window.jspdf) return;
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "letter" });
                    
                    const totalVentas = ventasList.reduce((acc, v) => acc + v.total, 0);
                    const totalCaja = cajaInfo.fondo + totalVentas;

                    // Encabezado
                    doc.setFontSize(22);
                    doc.setTextColor(40, 40, 40);
                    doc.setFont("helvetica", "bold");
                    doc.text("REPORTE DE CORTE DE CAJA", 105, 20, { align: 'center' });
                    
                    doc.setDrawColor(200, 200, 200);
                    doc.line(10, 25, 206, 25);

                    // Informaci√≥n General
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont("helvetica", "normal");
                    
                    doc.text(`Fecha de Corte: ${new Date().toLocaleString()}`, 15, 35);
                    doc.text(`Inicio de Turno: ${new Date(cajaInfo.inicio).toLocaleString()}`, 15, 42);
                    
                    // Resumen Financiero
                    doc.setFillColor(240, 240, 240);
                    doc.rect(15, 50, 186, 30, 'F');
                    doc.setFont("helvetica", "bold");
                    
                    doc.text("Fondo Inicial:", 20, 60);
                    doc.text(`$${cajaInfo.fondo.toFixed(2)}`, 190, 60, { align: 'right' });
                    
                    doc.text("Total Ventas:", 20, 70);
                    doc.setTextColor(0, 100, 0);
                    doc.text(`+ $${totalVentas.toFixed(2)}`, 190, 70, { align: 'right' });
                    
                    doc.setDrawColor(100, 100, 100);
                    doc.line(20, 74, 190, 74);
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(14);
                    doc.text("TOTAL EN CAJA:", 20, 82); // CORREGIDO (Antes dec√≠a "CAJA TOTAL:")
                    doc.text(`$${totalCaja.toFixed(2)}`, 190, 82, { align: 'right' });

                    // Detalle de Ventas
                    doc.setFontSize(14);
                    doc.text("Desglose de Movimientos", 15, 95);

                    const tableRows = ventasList.map(v => [
                        v.id.toString().slice(-6),
                        new Date(v.fecha).toLocaleTimeString(),
                        v.cliente.substring(0, 20),
                        v.equipo,
                        `$${v.total.toFixed(2)}`
                    ]);

                    doc.autoTable({
                        startY: 100,
                        head: [['Folio', 'Hora', 'Cliente', 'Origen', 'Monto']],
                        body: tableRows,
                        theme: 'striped',
                        headStyles: { fillColor: [44, 62, 80] },
                        styles: { fontSize: 10 }
                    });

                    // Footer
                    const finalY = doc.lastAutoTable.finalY + 20;
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "italic");
                    doc.text("Firma de Conformidad", 105, finalY, { align: 'center' });
                    doc.line(70, finalY - 5, 140, finalY - 5);

                    doc.save(`CorteCaja_${new Date().toISOString().slice(0,10)}.pdf`);
                } catch(e) { console.error("Error PDF Corte", e); }
            };

            // --- RENDER ---
            if (!usuarioActual) return <LoginScreen onLogin={setUsuarioActual} usuarios={usuarios} />;
            const eqSel = getEquipoActual();
            const ventasTurno = obtenerVentasTurno();
            const totalVentasTurno = ventasTurno.reduce((acc, v) => acc + v.total, 0);

            return (
                <div className="min-h-screen bg-slate-300 text-slate-800 font-sans pb-10">
                    {/* NAV */}
                    <nav className={`${COLOR_CORP} text-white shadow-lg sticky top-0 z-20`}>
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <Monitor className="text-cyan-400" />
                                <div><h1 className="font-bold leading-tight hidden md:block">{EMPRESA}</h1><p className="text-[10px] text-slate-400">{SISTEMA}</p></div>
                            </div>
                            <div className="flex items-center gap-2">
                                {/* BOTON CORTE DE CAJA (NUEVO) */}
                                <button onClick={() => setModalAbierto('caja')} className={`px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg border transition-all ${caja.activa ? 'bg-emerald-600 border-emerald-500 hover:bg-emerald-700' : 'bg-slate-700 border-slate-600 hover:bg-slate-600'}`}>
                                    <Wallet size={18} /> <span className="hidden sm:inline">{caja.activa ? `$${(caja.fondo + totalVentasTurno).toFixed(2)}` : 'Abrir Caja'}</span>
                                </button>
                                
                                <div className="h-6 w-px bg-slate-700 mx-1"></div>

                                <button onClick={abrirVentaDirecta} className="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg border border-orange-500 fade-anim">
                                    <Store size={18} /> <span className="hidden sm:inline">Venta</span>
                                </button>
                                
                                <button onClick={() => setChatAbierto(!chatAbierto)} className="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 animate-pulse hover:animate-none">
                                    <Sparkles size={14} className="text-yellow-300" /> IA
                                </button>
                                {usuarioActual.rol === 'admin' && (
                                    <>
                                        <button onClick={() => setModalAbierto('backup')} className="p-2 hover:bg-slate-700 rounded text-amber-300" title="Respaldo y Migraci√≥n"><Database size={20}/></button>
                                        <button onClick={() => setModalAbierto('estaciones')} className="p-2 hover:bg-slate-700 rounded text-cyan-300"><Settings size={20}/></button>
                                        <button onClick={() => setModalAbierto('usuarios')} className="p-2 hover:bg-slate-700 rounded"><UserCog size={20}/></button>
                                        <button onClick={() => setModalAbierto('inventario')} className="p-2 hover:bg-slate-700 rounded"><Package size={20}/></button>
                                    </>
                                )}
                                <button onClick={() => setModalAbierto('clientes')} className="p-2 hover:bg-slate-700 rounded"><Users size={20}/></button>
                                <div className="hidden md:flex items-center gap-2 mr-4 ml-2">
                                    <div className="bg-slate-700 px-3 py-1 rounded-full text-xs flex items-center gap-2">
                                        <Shield size={12} className={usuarioActual.rol === 'admin' ? 'text-emerald-400' : 'text-slate-400'}/>
                                        <span className="capitalize font-bold">{usuarioActual.nombre}</span>
                                    </div>
                                    <button onClick={() => setModalAbierto('cambiar_pin')} className="bg-slate-700 hover:bg-slate-600 p-1.5 rounded-full text-white"><Key size={12} /></button>
                                </div>
                                <button onClick={() => setUsuarioActual(null)} className="ml-2 bg-rose-600 p-2 rounded"><LogOut size={18}/></button>
                            </div>
                        </div>
                    </nav>

                    {/* DASHBOARD */}
                    <main className="max-w-7xl mx-auto px-4 py-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            {equipos.map(eq => {
                                const tiempoMs = calcularTiempo(eq);
                                const esPrepago = eq.modo === 'prepago';
                                const restante = eq.limiteTiempo - tiempoMs;
                                const alerta1Min = esPrepago && restante <= 60000 && restante > 0;
                                const finalizado = eq.estado === 'finalizado';
                                let cardClass = "bg-white rounded-lg shadow border border-slate-200 overflow-hidden hover:shadow-lg transition-all relative";
                                if (alerta1Min) cardClass += " border-orange-400 ring-2 ring-orange-200";
                                if (finalizado) cardClass += " alarm-active border-rose-600";

                                return (
                                    <div key={eq.id} className={cardClass}>
                                        <div className={`p-3 border-b flex justify-between items-center ${eq.estado === 'ocupado' ? 'bg-indigo-50' : finalizado ? 'bg-rose-100' : 'bg-slate-50'}`}>
                                            <div className="flex items-center gap-2">
                                                {eq.tipo === 'PC' ? <Monitor size={18} /> : <Gamepad2 size={18} />}
                                                <span className="font-bold">{eq.nombre}</span>
                                            </div>
                                            <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase ${eq.estado === 'libre' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-200 text-slate-600'}`}>
                                                {finalizado ? 'TIEMPO FINALIZADO' : eq.estado}
                                            </span>
                                        </div>
                                        <div className="p-4">
                                            <div className="text-center mb-4 relative">
                                                {esPrepago && !finalizado && (
                                                    <div className="w-full bg-slate-200 rounded-full h-1.5 mb-2 overflow-hidden">
                                                        <div className={`h-full ${alerta1Min ? 'bg-orange-500' : 'bg-indigo-500'}`} style={{ width: `${Math.max(0, (restante / eq.limiteTiempo) * 100)}%`, transition: 'width 1s linear' }}></div>
                                                    </div>
                                                )}
                                                <div className={`text-3xl font-mono ${finalizado ? 'text-rose-600 font-bold' : alerta1Min ? 'text-orange-500 animate-pulse' : 'text-slate-800'}`}>
                                                    {esPrepago && !finalizado ? new Date(Math.max(0, restante)).toISOString().substr(11, 8) : new Date(tiempoMs).toISOString().substr(11, 8) }
                                                </div>
                                                <div className="text-xs text-slate-400 uppercase font-bold">
                                                    {esPrepago ? (finalizado ? "SE REQUIERE COBRO" : "TIEMPO RESTANTE (PREPAGO)") : "TIEMPO TRANSCURRIDO"}
                                                </div>
                                            </div>
                                            <div className="flex justify-between items-center text-sm mb-4 bg-slate-50 p-2 rounded">
                                                <span className="text-slate-500">A Pagar:</span>
                                                <span className="font-bold text-xl text-slate-800">${(calcularTotalRenta(eq) + eq.cuenta.reduce((a,i)=>a+(i.precio * (i.cantidad || 1)),0)).toFixed(2)}</span>
                                            </div>
                                            <div className="grid grid-cols-4 gap-2">
                                                {eq.estado === 'libre' ? (
                                                    <>
                                                        <button onClick={() => iniciarTiempoLibre(eq.id)} className="col-span-2 bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded font-bold flex justify-center items-center gap-2 text-xs"><Play size={14}/> LIBRE</button>
                                                        <button onClick={() => abrirPrepago(eq.id)} className="col-span-2 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded font-bold flex justify-center items-center gap-2 text-xs"><Timer size={14}/> PREPAGO</button>
                                                    </>
                                                ) : (
                                                    <>
                                                        {!finalizado && !esPrepago && (
                                                            <button onClick={() => togglePausa(eq.id)} className={`col-span-2 py-2 rounded text-white font-bold flex justify-center items-center ${eq.estado === 'ocupado' ? 'bg-amber-500' : 'bg-emerald-500'}`}>
                                                                {eq.estado === 'ocupado' ? <Pause size={16}/> : <Play size={16}/>}
                                                            </button>
                                                        )}
                                                        {esPrepago && !finalizado && <div className="col-span-2 bg-indigo-100 text-indigo-700 rounded flex justify-center items-center text-xs font-bold border border-indigo-200"><Lock size={12} className="mr-1"/> BLOQUEADO</div>}
                                                        {finalizado && <div className="col-span-2 bg-rose-100 text-rose-700 rounded flex justify-center items-center text-xs font-bold border border-rose-200 animate-pulse"><Bell size={12} className="mr-1"/> ¬°COBRAR!</div>}
                                                        <button onClick={() => { setEquipoSeleccionadoId(eq.id); setModalAbierto('productos'); }} className="bg-slate-100 hover:bg-slate-200 text-slate-600 border border-slate-200 rounded flex justify-center items-center"><Coffee size={18}/></button>
                                                        <button onClick={() => { setEquipoSeleccionadoId(eq.id); setModalAbierto('cobrar'); }} className="bg-emerald-600 hover:bg-emerald-700 text-white rounded flex justify-center items-center shadow-lg transform active:scale-95" title="Cobrar"><CircleDollarSign size={18}/></button>
                                                        <button onClick={() => iniciarIntercambio(eq.id)} className="col-span-2 mt-1 bg-cyan-50 text-cyan-700 border border-cyan-200 py-1 rounded text-xs font-bold flex justify-center items-center gap-1 hover:bg-cyan-100"><ArrowRightLeft size={14}/> Mover</button>
                                                        <button onClick={() => cancelarServicio(eq.id)} className="col-span-2 mt-1 bg-white text-slate-400 border border-slate-200 py-1 rounded text-xs font-bold flex justify-center items-center gap-1 hover:text-rose-500 hover:border-rose-200 hover:bg-rose-50"><RotateCcw size={14} className="mr-1"/> Reset / Cancelar</button>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </main>

                    {/* --- MODAL DE CAJA (NUEVO) --- */}
                    {modalAbierto === 'caja' && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[80] fade-anim">
                            <div className="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden modal-anim">
                                <div className="bg-slate-800 p-4 text-white flex justify-between items-center"><h2 className="font-bold flex items-center gap-2"><Wallet/> Control de Caja</h2><button onClick={() => setModalAbierto(null)}><X/></button></div>
                                
                                {caja.activa ? (
                                    <div className="p-6">
                                        <div className="bg-emerald-50 border border-emerald-200 p-4 rounded-lg text-center mb-4">
                                            <p className="text-sm text-emerald-700 font-bold uppercase">Turno Activo Desde</p>
                                            <p className="text-xs text-slate-500">{new Date(caja.inicio).toLocaleString()}</p>
                                        </div>
                                        <div className="space-y-3 mb-6">
                                            <div className="flex justify-between items-center border-b pb-2">
                                                <span className="text-slate-500">Fondo Inicial</span>
                                                <span className="font-bold text-lg">${caja.fondo.toFixed(2)}</span>
                                            </div>
                                            <div className="flex justify-between items-center border-b pb-2">
                                                <span className="text-slate-500">Ventas Turno ({ventasTurno.length})</span>
                                                <span className="font-bold text-lg text-indigo-600">+${totalVentasTurno.toFixed(2)}</span>
                                            </div>
                                            <div className="flex justify-between items-center bg-slate-100 p-2 rounded">
                                                <span className="text-slate-700 font-bold">TOTAL EN CAJA</span>
                                                <span className="font-black text-2xl text-slate-800">${(caja.fondo + totalVentasTurno).toFixed(2)}</span>
                                            </div>
                                        </div>
                                        <button onClick={cerrarCaja} className="w-full bg-rose-600 hover:bg-rose-700 text-white py-3 rounded-lg font-bold shadow-lg">Cerrar Turno / Corte de Caja</button>
                                    </div>
                                ) : (
                                    <div className="p-6">
                                        <p className="text-sm text-slate-500 mb-4 text-center">La caja est√° cerrada. Ingresa el fondo inicial para comenzar.</p>
                                        <label className="block text-xs font-bold text-slate-500 mb-1">Monto Fondo Inicial</label>
                                        <div className="relative mb-6">
                                            <span className="absolute left-3 top-2.5 text-slate-400 font-bold">$</span>
                                            <input type="number" className="w-full border-2 border-slate-200 rounded-lg p-2 pl-8 text-lg font-bold outline-none focus:border-indigo-500" placeholder="0.00" value={cajaForm.fondo} onChange={e => setCajaForm({...cajaForm, fondo: e.target.value})} autoFocus />
                                        </div>
                                        <button onClick={abrirCaja} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold shadow-lg">Iniciar Turno</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* --- MODAL ESTACIONES (CONFIGURACION ACTUALIZADA) --- */}
                    {modalAbierto === 'estaciones' && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col modal-anim">
                                <div className="bg-slate-800 p-4 text-white flex justify-between items-center rounded-t-xl"><h2 className="font-bold flex items-center gap-2"><Settings /> Configuraci√≥n de Terminales</h2><button onClick={() => setModalAbierto(null)}><X /></button></div>
                                
                                {/* NUEVO: CONFIGURACION GENERAL */}
                                <div className="p-4 bg-yellow-50 border-b border-yellow-100 flex flex-col gap-4">
                                    <div className="flex items-center justify-between">
                                        <div className="text-sm text-yellow-800">
                                            <span className="font-bold block">Tarifa M√≠nima Global</span>
                                            <span className="text-xs opacity-75">Cobro m√≠nimo al iniciar renta</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold text-yellow-900">$</span>
                                            <input type="number" className="w-20 border border-yellow-300 rounded p-1 text-center font-bold" value={config.tarifaMinima} onChange={e => setConfig({...config, tarifaMinima: parseFloat(e.target.value) || 0})} />
                                        </div>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <div className="text-sm text-yellow-800">
                                            <span className="font-bold block">Formato Ticket Predeterminado</span>
                                            <span className="text-xs opacity-75">Selecciona el tama√±o de impresi√≥n</span>
                                        </div>
                                        <select className="border border-yellow-300 rounded p-1 text-sm font-bold bg-white" value={config.formatoTicket || '58mm'} onChange={e => setConfig({...config, formatoTicket: e.target.value})}>
                                            <option value="58mm">Ticket T√©rmico (58mm)</option>
                                            <option value="LETTER">Carta (PDF Completo)</option>
                                        </select>
                                    </div>
                                </div>

                                <div className="p-6 bg-slate-50 flex gap-6 overflow-auto">
                                    <div className="w-1/2 bg-white p-4 rounded shadow-sm h-fit space-y-3 border">
                                        <h3 className="font-bold text-sm text-slate-500 uppercase">{estacionForm.id ? "Editar Estaci√≥n" : "Nueva Estaci√≥n"}</h3>
                                        <input className="w-full border p-2 rounded text-sm outline-none focus:border-indigo-500" placeholder="Nombre (Ej. PC-01)" value={estacionForm.nombre} onChange={e => setEstacionForm({...estacionForm, nombre: e.target.value})} />
                                        <select className="w-full border p-2 rounded text-sm outline-none focus:border-indigo-500" value={estacionForm.tipo} onChange={e => setEstacionForm({...estacionForm, tipo: e.target.value})}><option value="PC">PC / Computadora</option><option value="CONSOLA">Consola (Xbox/PS)</option></select>
                                        <div className="flex items-center gap-2"><span className="text-sm font-bold">$</span><input type="number" className="w-full border p-2 rounded text-sm outline-none focus:border-indigo-500" placeholder="Precio por Hora" value={estacionForm.precioHora} onChange={e => setEstacionForm({...estacionForm, precioHora: e.target.value})} /></div>
                                        <button onClick={guardarEstacion} className="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700 shadow transition-all">{estacionForm.id ? "Actualizar" : "Crear"}</button>
                                        {estacionForm.id && <button onClick={() => setEstacionForm({ id: null, nombre: '', tipo: 'PC', precioHora: '' })} className="w-full border py-1 rounded text-xs text-slate-500">Cancelar Edici√≥n</button>}
                                    </div>
                                    <div className="w-1/2 bg-white rounded shadow-sm overflow-hidden border overflow-y-auto max-h-80">
                                        {equipos.map(e => (
                                            <div key={e.id} className="p-3 border-b flex justify-between items-center hover:bg-slate-50">
                                                <div><div className="font-bold text-sm">{e.nombre}</div><div className="text-xs text-slate-400">{e.tipo} - ${e.precioHora}/hr</div></div>
                                                <div className="flex gap-2"><button onClick={() => prepararEdicionEstacion(e)} className="text-indigo-600 hover:bg-indigo-50 p-1 rounded"><Edit2 size={16}/></button><button onClick={() => eliminarEstacion(e.id)} className="text-rose-600 hover:bg-rose-50 p-1 rounded"><Trash2 size={16}/></button></div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ... (RESTO DE MODALES EXISTENTES SIN CAMBIOS MAYORES) ... */}

                    {/* --- MODAL CONFIRMACION RESET --- */}
                    {confirmarResetId && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[80] fade-anim">
                            <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full modal-anim text-center">
                                <div className="mb-4 text-rose-600 flex justify-center"><AlertTriangle size={48}/></div>
                                <h3 className="font-bold text-lg mb-2 text-slate-800">¬øReiniciar Estaci√≥n?</h3>
                                <p className="text-sm text-slate-500 mb-6">Se perder√° el tiempo y el consumo actual sin cobrar. Esta acci√≥n no se puede deshacer.</p>
                                <div className="flex gap-2">
                                    <button onClick={() => setConfirmarResetId(null)} className="flex-1 border py-2 rounded text-slate-600 font-bold hover:bg-slate-50">Cancelar</button>
                                    <button onClick={ejecutarReset} className="flex-1 bg-rose-600 text-white py-2 rounded font-bold hover:bg-rose-700 shadow-lg">S√≠, Reiniciar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL VENTA DIRECTA --- */}
                    {modalAbierto === 'venta_directa' && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-6 fade-anim">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-7xl h-full sm:h-[90vh] flex flex-col overflow-hidden modal-anim">
                                {/* Header */}
                                <div className="bg-orange-600 p-4 text-white flex justify-between items-center border-b border-orange-700">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-white/20 p-2 rounded-lg"><Store size={24} className="text-white" /></div>
                                        <div><h2 className="font-bold text-lg leading-none">Venta de Mostrador</h2><p className="text-xs text-orange-200 opacity-90">Clientes sin equipo asignado</p></div>
                                    </div>
                                    <button onClick={() => setModalAbierto(null)} className="hover:bg-white/20 p-2 rounded-full"><X size={24} /></button>
                                </div>
                                <div className="flex flex-1 overflow-hidden bg-slate-100 flex-col sm:flex-row">
                                    <div className="flex-1 flex flex-col sm:flex-row overflow-hidden">
                                        {/* Left Column: Inventario */}
                                        <div className="w-full sm:w-1/2 flex flex-col border-r border-slate-200 bg-white">
                                            <div className="p-3 border-b bg-slate-50 flex justify-between items-center"><h3 className="font-bold text-xs text-slate-500 uppercase flex items-center gap-2"><Package size={14}/> Inventario (Clic para agregar)</h3></div>
                                            <div className="flex-1 overflow-y-auto p-3">
                                                <div className="grid grid-cols-1 gap-2">
                                                    {catalogo.map(prod => (
                                                        <button key={prod.id} disabled={prod.stock < 1} onClick={() => agregarProductoDirecto(prod)} className="flex items-center gap-3 p-3 bg-white border rounded-lg hover:border-orange-500 hover:bg-orange-50 hover:shadow-md text-left disabled:opacity-50 transition-all group">
                                                            <span className="text-2xl">{prod.icon}</span>
                                                            <div className="min-w-0 flex-1">
                                                                <div className="text-sm font-bold text-slate-700 truncate group-hover:text-orange-700">{prod.nombre}</div>
                                                                <div className="flex justify-between items-center mt-1">
                                                                    <span className="text-xs text-orange-600 font-bold bg-orange-50 px-2 py-0.5 rounded">${prod.precio}</span>
                                                                    <span className={`text-[10px] px-1.5 rounded font-bold ${prod.stock < 5 ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-500'}`}>Stock: {prod.stock}</span>
                                                                </div>
                                                            </div>
                                                            <PlusCircle size={20} className="text-slate-200 group-hover:text-orange-500"/>
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                        {/* Right Column: Servicios */}
                                        <div className="w-full sm:w-1/2 flex flex-col bg-white border-l border-slate-200">
                                            <div className="p-3 border-b bg-indigo-50"><h3 className="font-bold text-xs text-indigo-700 uppercase flex items-center gap-2"><Printer size={14}/> Servicios R√°pidos</h3></div>
                                            <div className="p-4 space-y-4 overflow-y-auto flex-1">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-2">1. Selecciona Servicio</label>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        {[{ id: 'IMPRESION_BN', label: 'Imp. B/N', icon: <FileText size={18}/>, color: 'text-slate-600' }, { id: 'IMPRESION_COLOR', label: 'Imp. Color', icon: <Printer size={18}/>, color: 'text-pink-500' }, { id: 'ESCANEO', label: 'Escaneo', icon: <ScanBarcode size={18}/>, color: 'text-blue-500' }, { id: 'ENVIO', label: 'Env√≠o', icon: <Bluetooth size={18}/>, color: 'text-indigo-500' }].map(opt => (
                                                            <button key={opt.id} onClick={() => setServicioForm({...servicioForm, tipo: opt.id})} className={`p-2 rounded-lg border text-sm font-bold flex flex-col items-center gap-1 transition-all ${servicioForm.tipo === opt.id ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white text-slate-600 hover:bg-slate-50'}`}>
                                                                <div className={servicioForm.tipo === opt.id ? 'text-white' : opt.color}>{opt.icon}</div>{opt.label}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                                
                                                <div className="grid grid-cols-2 gap-3">
                                                    <button onClick={() => setServicioForm({ ...servicioForm, tipo: 'WIFI' })} className={`p-3 rounded-lg border text-sm font-bold flex flex-col items-center gap-2 transition-all hover:scale-105 ${servicioForm.tipo === 'WIFI' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-50'}`}>
                                                        <div className={servicioForm.tipo === 'WIFI' ? 'text-white' : 'text-emerald-500'}><Wifi size={20}/></div>WiFi ($10)
                                                    </button>
                                                    <button onClick={() => setServicioForm({ ...servicioForm, tipo: 'ASESORIA' })} className={`p-3 rounded-lg border text-sm font-bold flex flex-col items-center gap-2 transition-all hover:scale-105 ${servicioForm.tipo === 'ASESORIA' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-50'}`}>
                                                        <div className={servicioForm.tipo === 'ASESORIA' ? 'text-white' : 'text-amber-500'}><HandHelping size={20}/></div>Asesor√≠a ($15)
                                                    </button>
                                                </div>

                                                {(servicioForm.tipo === 'IMPRESION_BN' || servicioForm.tipo === 'IMPRESION_COLOR') && (
                                                    <div className="fade-anim">
                                                        <label className="block text-xs font-bold text-slate-500 mb-2">2. Intensidad / Tipo</label>
                                                        <div className="grid grid-cols-3 gap-2">
                                                            {[{ id: 'B', label: 'B√°sica', price: PRECIOS_IMPRESION[servicioForm.tipo]['B'] }, { id: 'M', label: 'Media', price: PRECIOS_IMPRESION[servicioForm.tipo]['M'] }, { id: 'G', label: 'Alta', price: PRECIOS_IMPRESION[servicioForm.tipo]['G'] }].map(cob => (
                                                                <button key={cob.id} onClick={() => setServicioForm({...servicioForm, cobertura: cob.id})} className={`p-2 rounded border text-center text-xs font-bold transition-all ${servicioForm.cobertura === cob.id ? 'bg-indigo-50 border-indigo-500 text-indigo-700 ring-1 ring-indigo-500' : 'bg-white text-slate-600'}`}>
                                                                    {cob.label}<br/><span className="text-slate-400 font-normal">${cob.price}</span>
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                <div className="bg-slate-50 p-3 rounded-xl border border-slate-200">
                                                    {servicioForm.tipo !== 'ENVIO' && servicioForm.tipo !== 'WIFI' && servicioForm.tipo !== 'ASESORIA' && (
                                                        <div className="flex bg-white p-1 rounded-lg border mb-3">
                                                            {['CARTA', 'OFICIO', 'TABLOIDE'].map(tam => ((servicioForm.tipo === 'ESCANEO' && tam === 'TABLOIDE') ? null : <button key={tam} onClick={() => setServicioForm({...servicioForm, tamano: tam})} className={`flex-1 py-1 text-[10px] rounded font-bold transition-all ${servicioForm.tamano === tam ? 'bg-white text-indigo-600 shadow-sm transform scale-105' : 'text-slate-400 hover:text-slate-600'}`}>{tam}</button>))}
                                                        </div>
                                                    )}
                                                    <div className="flex gap-2 items-center mb-3">
                                                        <div className="flex-1"><label className="block text-[10px] font-bold text-slate-500 mb-1">Cant.</label><input type="number" min="1" className="w-full border p-2 rounded-lg font-bold text-center outline-none focus:border-indigo-500" value={servicioForm.cantidad} onChange={e => setServicioForm({...servicioForm, cantidad: parseInt(e.target.value) || 1})} /></div>
                                                        <div className="flex-[2] text-right"><div className="text-[10px] text-slate-400 uppercase font-bold">Total Item</div><div className="text-xl font-black text-slate-800">${(() => { const { tipo, tamano, cobertura } = servicioForm; let p = 0; if(tipo === 'ENVIO') p = OTROS_SERVICIOS['ENVIO']['GENERAL']; else if(tipo === 'ESCANEO') p = OTROS_SERVICIOS['ESCANEO'][tamano]; else if (tipo === 'WIFI') p = OTROS_SERVICIOS['WIFI']['GENERAL']; else if (tipo === 'ASESORIA') p = OTROS_SERVICIOS['ASESORIA']['GENERAL']; else { const base = PRECIOS_IMPRESION[tipo] ? PRECIOS_IMPRESION[tipo][cobertura] : 0; const mod = MODIFICADOR_TAMANO[tamano]; p = mod.op === 'add' ? base + mod.val : base * mod.val; } if (servicioForm.cantidad > 10) p = p * 0.9; return (p * servicioForm.cantidad).toFixed(2); })()}</div></div>
                                                    </div>
                                                    <button onClick={agregarServicioDirecto} className="w-full bg-slate-900 hover:bg-black text-white py-2 rounded-lg font-bold shadow flex justify-center items-center gap-2 text-sm"><CheckCircle size={16}/> Agregar</button>
                                                </div>
                                                
                                                <div className="mt-4 pt-4 border-t border-slate-200">
                                                    <label className="block text-xs font-bold text-slate-500 mb-2">Agregar Cargo Manual</label>
                                                    <div className="flex gap-2">
                                                        <input className="flex-1 border p-2 rounded text-sm" placeholder="Concepto (ej. Engargolado)" value={manualItemForm.nombre} onChange={e => setManualItemForm({...manualItemForm, nombre: e.target.value})} />
                                                        <input className="w-20 border p-2 rounded text-sm" type="number" placeholder="$" value={manualItemForm.precio} onChange={e => setManualItemForm({...manualItemForm, precio: e.target.value})} />
                                                        <button onClick={agregarManualDirecto} className="bg-slate-700 text-white px-3 rounded hover:bg-slate-800"><PlusCircle size={18}/></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {/* Right Column: Carrito */}
                                    <div className="w-full sm:w-96 bg-white border-l border-slate-200 flex flex-col shadow-2xl z-20 h-1/3 sm:h-auto border-t sm:border-t-0">
                                        <div className="p-4 bg-orange-50 border-b border-orange-100 flex justify-between items-center"><div><h3 className="font-bold text-orange-800 text-sm uppercase">Carrito Mostrador</h3></div><span className="bg-orange-200 text-orange-800 px-2 py-1 rounded-full text-xs font-bold">{carritoDirecto.length} Items</span></div>
                                        <div className="px-4 py-2 bg-white border-b border-slate-100">
                                            <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Cliente (Para Puntos)</label>
                                            <div className="flex gap-2">
                                                <select className="flex-1 border text-sm rounded p-1 bg-slate-50" value={ventaDirectaClienteId} onChange={e => setVentaDirectaClienteId(e.target.value)}>{clientes.map(c => <option key={c.id} value={c.id}>{c.nombre}</option>)}</select>
                                                <button onClick={() => setMostrarNuevoCliente(!mostrarNuevoCliente)} className="bg-indigo-100 text-indigo-600 p-1 rounded hover:bg-indigo-200" title="Nuevo Cliente"><UserPlus size={18}/></button>
                                            </div>
                                            {mostrarNuevoCliente && (<div className="mt-2 bg-indigo-50 p-2 rounded flex gap-2 fade-anim"><input className="flex-1 text-xs border rounded p-1" placeholder="Nombre Cliente" value={nuevoClienteNombre} onChange={e => setNuevoClienteNombre(e.target.value)} autoFocus /><button onClick={agregarClienteRapido} className="bg-indigo-600 text-white text-xs font-bold px-2 rounded hover:bg-indigo-700">OK</button></div>)}
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-3 space-y-2 bg-slate-50/50">
                                            {carritoDirecto.length === 0 ? (<div className="flex flex-col items-center justify-center h-full text-slate-400 opacity-60"><ShoppingBag size={48} className="mb-2 stroke-1"/><span className="text-xs font-medium">Carrito vac√≠o</span></div>) : (carritoDirecto.map((i) => (<div key={i.uid} className="bg-white p-3 rounded-lg shadow-sm border border-slate-200 flex justify-between items-center group"><div><div className="font-bold text-sm text-slate-800">{i.nombre}</div><div className="text-xs text-slate-400">{i.cantidad} x ${i.precio}</div></div><div className="flex items-center gap-3"><div className="font-bold text-emerald-600 text-sm">${(i.precio * (i.cantidad || 1)).toFixed(2)}</div><button onClick={() => eliminarItemDirecto(i.uid)} className="text-slate-300 hover:text-rose-500"><X size={16}/></button></div></div>)))}
                                        </div>
                                        <div className="bg-white border-t border-slate-200 p-5 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="font-bold text-lg text-slate-700">Total a Cobrar</span>
                                                <span className="font-black text-3xl text-orange-600">${carritoDirecto.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0).toFixed(2)}</span>
                                            </div>
                                            
                                            {/* PAGO CON y CAMBIO en Venta Directa */}
                                            <div className="mb-4 bg-slate-50 p-2 rounded border border-slate-100">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <label className="text-xs font-bold text-slate-500 w-20">Paga con:</label>
                                                    <input type="number" className="flex-1 border p-1 rounded text-sm font-bold text-right" placeholder="$0.00" value={pagoConDirecto} onChange={e => setPagoConDirecto(e.target.value)}/>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <label className="text-xs font-bold text-slate-500 w-20">Cambio:</label>
                                                    <div className="flex-1 text-right text-lg font-black text-emerald-600">${(parseFloat(pagoConDirecto) - carritoDirecto.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0)).toFixed(2)}</div>
                                                </div>
                                            </div>

                                            <button onClick={cobrarVentaDirecta} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-emerald-200 transition-all transform hover:-translate-y-0.5 active:translate-y-0 flex justify-center items-center gap-2"><CircleDollarSign size={24}/> COBRAR AHORA</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL INVENTARIO --- */}
                    {modalAbierto === 'inventario' && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                            <div className="bg-white rounded-xl w-full max-w-5xl max-h-[90vh] flex flex-col shadow-2xl modal-anim">
                                <div className="bg-indigo-700 p-4 text-white flex justify-between items-center rounded-t-xl"><h2 className="font-bold flex items-center gap-2"><Package /> Inventario</h2><button onClick={()=>{ setModalAbierto(null); setShowCamera(false); }}><X/></button></div>
                                <div className="flex-1 p-6 bg-slate-50 flex gap-6 overflow-hidden">
                                    <div className="w-1/3 bg-white p-5 rounded-lg shadow-sm border h-fit space-y-4 overflow-y-auto">
                                        <h3 className="font-bold text-slate-700 border-b pb-2 flex justify-between items-center">{itemForm.id ? "Editar" : "Nuevo"} {itemForm.id && <button onClick={() => setItemForm({ id: null, nombre: '', precio: '', stock: '', categoria: 'General', codigo: '' })} className="text-xs text-indigo-600 underline">Cancelar</button>}</h3>
                                        <div className="border rounded bg-slate-100 overflow-hidden relative"><button onClick={() => setShowCamera(!showCamera)} className={`w-full py-2 text-xs font-bold flex justify-center items-center gap-2 ${showCamera ? 'bg-slate-200 text-slate-600' : 'bg-slate-800 text-white hover:bg-slate-900'}`}>{showCamera ? <><CameraOff size={14}/> Detener C√°mara</> : <><Camera size={14}/> Usar C√°mara / QR</>}</button>{showCamera && <div id="reader" className="w-full h-48 bg-black"></div>}</div>
                                        <div><label className="text-xs font-bold text-slate-500">Producto</label><input className="w-full border p-2 rounded mt-1 outline-none focus:border-indigo-500" value={itemForm.nombre} onChange={e => setItemForm({...itemForm, nombre: e.target.value})} placeholder="Ej. Coca Cola" /></div>
                                        <div className="flex gap-2"><div className="flex-1"><label className="text-xs font-bold text-slate-500">Precio</label><input type="number" className="w-full border p-2 rounded mt-1 outline-none focus:border-indigo-500" value={itemForm.precio} onChange={e => setItemForm({...itemForm, precio: e.target.value})} placeholder="0.00" /></div><div className="flex-1"><label className="text-xs font-bold text-slate-500">Stock</label><input type="number" className="w-full border p-2 rounded mt-1 outline-none focus:border-indigo-500" value={itemForm.stock} onChange={e => setItemForm({...itemForm, stock: e.target.value})} placeholder="0" /></div></div>
                                        <div><label className="text-xs font-bold text-slate-500">Categor√≠a</label><select className="w-full border p-2 rounded mt-1 outline-none focus:border-indigo-500" value={itemForm.categoria} onChange={e => setItemForm({...itemForm, categoria: e.target.value})}><option value="General">General</option><option value="Bebidas">Bebidas</option><option value="Snacks">Snacks</option><option value="Papeler√≠a">Papeler√≠a</option><option value="Tecnolog√≠a">Tecnolog√≠a</option></select></div>
                                        <div><label className="text-xs font-bold text-slate-500">C√≥digo</label><div className="relative"><input className="w-full border p-2 pl-8 rounded mt-1 outline-none focus:border-indigo-500 bg-slate-50" value={itemForm.codigo} onChange={e => setItemForm({...itemForm, codigo: e.target.value})} placeholder="Escanear..." /><ScanBarcode size={16} className="absolute left-2.5 top-4 text-slate-400"/></div></div>
                                        <button onClick={guardarProductoInventario} className="w-full bg-indigo-600 text-white py-2.5 rounded font-bold hover:bg-indigo-700 shadow transition-all flex justify-center items-center gap-2"><Save size={18}/> Guardar</button>
                                    </div>
                                    <div className="w-2/3 bg-white rounded-lg shadow-sm border overflow-hidden flex flex-col">
                                        <div className="overflow-y-auto flex-1">
                                            <table className="w-full text-sm text-left">
                                                <thead className="bg-slate-100 text-slate-600 font-bold sticky top-0 shadow-sm"><tr><th className="p-3">Producto</th><th className="p-3">Categor√≠a</th><th className="p-3">Precio</th><th className="p-3 text-center">Stock</th><th className="p-3 text-center">Acciones</th></tr></thead>
                                                <tbody>
                                                    {catalogo.map(p => (
                                                        <tr key={p.id} className="border-b hover:bg-slate-50 group transition-colors">
                                                            <td className="p-3 font-medium flex items-center gap-2"><span className="text-lg">{p.icon}</span> <div><div>{p.nombre}</div><div className="text-[10px] text-slate-400 font-mono flex items-center gap-1">{p.codigo ? <><QrCode size={10}/> {p.codigo}</> : 'Sin c√≥digo'}</div></div></td>
                                                            <td className="p-3 text-slate-500"><span className="bg-slate-100 px-2 py-0.5 rounded-full text-xs">{p.categoria}</span></td>
                                                            <td className="p-3 font-bold text-slate-700">${p.precio.toFixed(2)}</td>
                                                            <td className="p-3 text-center"><span className={`font-bold px-2 py-0.5 rounded text-xs ${p.stock < 5 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-700'}`}>{p.stock}</span></td>
                                                            <td className="p-3 flex justify-center gap-2"><button onClick={() => prepararEdicionProducto(p)} className="p-1.5 text-indigo-600 hover:bg-indigo-50 rounded transition-colors" title="Editar"><Edit2 size={16}/></button><button onClick={() => eliminarProductoInventario(p.id)} className="p-1.5 text-rose-600 hover:bg-rose-50 rounded transition-colors" title="Eliminar"><Trash2 size={16}/></button></td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL CLIENTES --- */}
                    {modalAbierto === 'clientes' && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden modal-anim">
                                <div className="bg-slate-700 p-4 text-white flex justify-between items-center"><h2 className="font-bold flex gap-2"><Users/> Clientes</h2><button onClick={() => setModalAbierto(null)}><X/></button></div>
                                <div className="p-4 bg-slate-50">
                                    <div className="flex gap-2 mb-4"><input className="flex-1 border p-2 rounded" placeholder="Nombre Nuevo Cliente" value={clienteForm.nombre} onChange={e => setClienteForm({nombre: e.target.value})} /><button onClick={() => { if(clienteForm.nombre){ setClientes(p => [...p, {id: Date.now(), nombre: clienteForm.nombre, puntos: 0}]); setClienteForm({nombre:''}); }}} className="bg-slate-700 text-white px-4 rounded font-bold">Agregar</button></div>
                                    <div className="bg-white border rounded h-64 overflow-y-auto">
                                        {clientes.map(c => (
                                            <div key={c.id} className="p-3 border-b flex justify-between items-center hover:bg-slate-50">
                                                <div><div className="font-bold flex items-center gap-2">{c.nombre}{c.id === 1 && <span className="bg-slate-200 text-slate-500 text-[10px] px-1 rounded uppercase">P√∫blico</span>}</div><div className="text-xs text-slate-400">ID: {c.id}</div></div>
                                                <div className="flex items-center gap-3">{c.id !== 1 ? <span className="bg-amber-100 text-amber-700 px-2 py-1 rounded text-xs font-bold flex items-center gap-1"><Trophy size={12}/> {c.puntos} pts</span> : <span className="text-slate-300 text-xs italic">Sin Puntos</span>}{c.id !== 1 && <button onClick={() => setClientes(p => p.filter(x => x.id !== c.id))} className="text-rose-400 hover:text-rose-600"><Trash2 size={14}/></button>}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL USUARIOS --- */}
                    {modalAbierto === 'usuarios' && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col modal-anim">
                                <div className="bg-slate-800 p-4 text-white flex justify-between items-center rounded-t-xl"><h2 className="font-bold flex items-center gap-2"><UserCog /> Personal</h2><button onClick={() => setModalAbierto(null)}><X /></button></div>
                                <div className="p-6 bg-slate-50 flex gap-6 overflow-auto">
                                    <div className="w-1/3 bg-white p-4 rounded shadow-sm h-fit space-y-3 border">
                                        <h3 className="font-bold text-sm text-slate-500 uppercase">Nuevo Usuario</h3>
                                        <input className="w-full border p-2 rounded text-sm outline-none focus:border-indigo-500" placeholder="Nombre" value={usuarioForm.nombre} onChange={e => setUsuarioForm({...usuarioForm, nombre: e.target.value})} />
                                        <div className="relative"><input className="w-full border p-2 pl-8 rounded text-sm outline-none focus:border-indigo-500" placeholder="PIN" maxLength="4" value={usuarioForm.pin} onChange={e => setUsuarioForm({...usuarioForm, pin: e.target.value.replace(/\D/g,'')})} /><Lock size={14} className="absolute left-2.5 top-3 text-slate-400"/></div>
                                        <select className="w-full border p-2 rounded text-sm outline-none focus:border-indigo-500" value={usuarioForm.rol} onChange={e => setUsuarioForm({...usuarioForm, rol: e.target.value})}><option value="empleado">Empleado</option><option value="admin">Administrador</option></select>
                                        <button onClick={guardarUsuario} className="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700 shadow transition-all">Crear</button>
                                    </div>
                                    <div className="w-2/3 bg-white rounded shadow-sm overflow-hidden border">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-slate-100 text-slate-600 font-bold"><tr><th className="p-3">Nombre</th><th className="p-3">Rol</th><th className="p-3">PIN</th><th className="p-3"></th></tr></thead>
                                            <tbody>
                                                {usuarios.map(u => (
                                                    <tr key={u.id} className="border-b hover:bg-slate-50">
                                                        <td className="p-3 font-bold">{u.nombre}</td>
                                                        <td className="p-3"><span className={`px-2 py-0.5 rounded text-[10px] uppercase font-bold ${u.rol === 'admin' ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-100 text-slate-600'}`}>{u.rol}</span></td>
                                                        <td className="p-3 font-mono text-slate-400">****</td>
                                                        <td className="p-3 text-right">{u.id !== 1 && <button onClick={() => eliminarUsuario(u.id)} className="text-rose-500 hover:bg-rose-50 p-1 rounded transition-colors"><Trash2 size={16}/></button>}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL PRODUCTOS Y SERVICIOS (SIDEBAR ESTACIONES) --- */}
                    {modalAbierto === 'productos' && eqSel && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                             <div className="bg-white rounded-xl shadow-2xl w-full max-w-7xl h-[90vh] flex flex-col overflow-hidden modal-anim">
                                <div className="bg-slate-800 p-4 text-white flex justify-between items-center border-b border-slate-700">
                                    <h2 className="font-bold flex items-center gap-2"><ShoppingBag className="text-cyan-400" /> {eqSel.nombre}</h2>
                                    <button onClick={() => setModalAbierto(null)}><X /></button>
                                </div>
                                <div className="flex flex-1 overflow-hidden bg-slate-100">
                                    <div className="flex-1 flex overflow-hidden mr-1">
                                        <div className="w-1/2 flex flex-col border-r border-slate-200 bg-white">
                                            <div className="p-3 border-b bg-slate-50 flex justify-between items-center"><h3 className="font-bold text-xs text-slate-500 uppercase flex items-center gap-2"><Package size={14}/> Inventario</h3></div>
                                            <div className="flex-1 overflow-y-auto p-3"><div className="grid grid-cols-1 gap-2">{catalogo.map(prod => (<button key={prod.id} disabled={prod.stock < 1} onClick={() => agregarProductoACuenta(prod)} className="flex items-center gap-3 p-3 bg-white border rounded-lg hover:border-cyan-500 hover:bg-cyan-50 hover:shadow-md text-left disabled:opacity-50 transition-all"><span className="text-2xl">{prod.icon}</span><div className="min-w-0 flex-1"><div className="text-sm font-bold text-slate-700 truncate">{prod.nombre}</div><div className="flex justify-between items-center mt-1"><span className="text-xs text-cyan-600 font-bold bg-cyan-50 px-2 py-0.5 rounded">${prod.precio}</span><span className={`text-[10px] px-1.5 rounded font-bold ${prod.stock < 5 ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-500'}`}>Stock: {prod.stock}</span></div></div><ChevronRight size={16} className="text-slate-300"/></button>))}</div></div>
                                        </div>
                                        <div className="w-1/2 flex flex-col bg-white">
                                            <div className="p-3 border-b bg-indigo-50"><h3 className="font-bold text-xs text-indigo-700 uppercase flex items-center gap-2"><Printer size={14}/> Servicios R√°pidos</h3></div>
                                            <div className="p-5 space-y-6 overflow-y-auto">
                                                <div><label className="block text-xs font-bold text-slate-500 mb-2">1. Selecciona Servicio</label><div className="grid grid-cols-2 gap-3">{[{ id: 'IMPRESION_BN', label: 'Impresi√≥n B/N', icon: <FileText size={20}/>, color: 'text-slate-600' }, { id: 'IMPRESION_COLOR', label: 'Impresi√≥n Color', icon: <Printer size={20}/>, color: 'text-pink-500' }, { id: 'ESCANEO', label: 'Escaneo', icon: <ScanBarcode size={20}/>, color: 'text-blue-500' }, { id: 'ENVIO', label: 'Env√≠o Digital', icon: <Bluetooth size={20}/>, color: 'text-indigo-500' }].map(opt => (<button key={opt.id} onClick={() => setServicioForm({...servicioForm, tipo: opt.id})} className={`p-3 rounded-lg border text-sm font-bold flex flex-col items-center gap-2 transition-all hover:scale-105 ${servicioForm.tipo === opt.id ? 'bg-indigo-600 text-white border-indigo-600 shadow-lg ring-2 ring-indigo-200' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50 shadow-sm'}`}><div className={servicioForm.tipo === opt.id ? 'text-white' : opt.color}>{opt.icon}</div>{opt.label}</button>))}</div></div>
                                                <div className="grid grid-cols-2 gap-3"><button onClick={() => setServicioForm({ ...servicioForm, tipo: 'WIFI' })} className={`p-3 rounded-lg border text-sm font-bold flex flex-col items-center gap-2 transition-all hover:scale-105 ${servicioForm.tipo === 'WIFI' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-50'}`}><div className={servicioForm.tipo === 'WIFI' ? 'text-white' : 'text-emerald-500'}><Wifi size={20}/></div>WiFi ($10)</button><button onClick={() => setServicioForm({ ...servicioForm, tipo: 'ASESORIA' })} className={`p-3 rounded-lg border text-sm font-bold flex flex-col items-center gap-2 transition-all hover:scale-105 ${servicioForm.tipo === 'ASESORIA' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-50'}`}><div className={servicioForm.tipo === 'ASESORIA' ? 'text-white' : 'text-amber-500'}><HandHelping size={20}/></div>Asesor√≠a ($15)</button></div>
                                                {(servicioForm.tipo === 'IMPRESION_BN' || servicioForm.tipo === 'IMPRESION_COLOR') && (<div className="fade-anim"><label className="block text-xs font-bold text-slate-500 mb-2 flex items-center gap-1"><Droplet size={12}/> 2. Cobertura de Tinta</label><div className="grid grid-cols-3 gap-2">{[{ id: 'B', label: 'B√°sica', desc: 'Texto simple', price: PRECIOS_IMPRESION[servicioForm.tipo]['B'] }, { id: 'M', label: 'Media', desc: 'Con im√°genes', price: PRECIOS_IMPRESION[servicioForm.tipo]['M'] }, { id: 'G', label: 'Alta', desc: 'Fotos / Full', price: PRECIOS_IMPRESION[servicioForm.tipo]['G'] }].map(cob => (<button key={cob.id} onClick={() => setServicioForm({...servicioForm, cobertura: cob.id})} className={`p-2 rounded-lg border text-left transition-all ${servicioForm.cobertura === cob.id ? 'bg-indigo-50 border-indigo-500 ring-1 ring-indigo-500' : 'bg-white border-slate-200 hover:bg-slate-50'}`}><div className="flex justify-between items-center mb-1"><span className={`font-bold text-xs ${servicioForm.cobertura === cob.id ? 'text-indigo-700' : 'text-slate-700'}`}>{cob.label}</span><span className="text-[10px] font-bold bg-slate-100 px-1.5 rounded text-slate-600">${cob.price}</span></div><div className="text-[10px] text-slate-400 leading-tight">{cob.desc}</div></button>))}</div></div>)}
                                                {servicioForm.tipo !== 'ENVIO' && servicioForm.tipo !== 'WIFI' && servicioForm.tipo !== 'ASESORIA' && (<div className="fade-anim delay-75"><label className="block text-xs font-bold text-slate-500 mb-2">3. Tama√±o de Papel</label><div className="flex bg-slate-100 p-1 rounded-lg">{['CARTA', 'OFICIO', 'TABLOIDE'].map(tam => ((servicioForm.tipo === 'ESCANEO' && tam === 'TABLOIDE') ? null : <button key={tam} onClick={() => setServicioForm({...servicioForm, tamano: tam})} className={`flex-1 py-2 text-xs rounded-md font-bold transition-all ${servicioForm.tamano === tam ? 'bg-white text-indigo-600 shadow-sm transform scale-105' : 'text-slate-400 hover:text-slate-600'}`}>{tam}</button>))}</div></div>)}
                                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200"><div className="flex gap-4 items-end mb-3"><div className="w-24"><label className="block text-xs font-bold text-slate-500 mb-1">Cantidad</label><input type="number" min="1" className="w-full border-2 border-slate-300 p-2 rounded-lg font-bold text-center text-lg focus:border-indigo-500 outline-none" value={servicioForm.cantidad} onChange={e => setServicioForm({...servicioForm, cantidad: parseInt(e.target.value) || 1})} /></div><div className="flex-1 text-right"><div className="text-xs text-slate-400 uppercase font-bold">Total Estimado</div><div className="text-2xl font-black text-slate-800 tracking-tight">${(() => { const { tipo, tamano, cobertura } = servicioForm; let p = 0; if(tipo === 'ENVIO') p = OTROS_SERVICIOS['ENVIO']['GENERAL']; else if(tipo === 'ESCANEO') p = OTROS_SERVICIOS['ESCANEO'][tamano]; else if (tipo === 'WIFI') p = OTROS_SERVICIOS['WIFI']['GENERAL']; else if (tipo === 'ASESORIA') p = OTROS_SERVICIOS['ASESORIA']['GENERAL']; else { const base = PRECIOS_IMPRESION[tipo] ? PRECIOS_IMPRESION[tipo][cobertura] : 0; const mod = MODIFICADOR_TAMANO[tamano]; p = mod.op === 'add' ? base + mod.val : base * mod.val; } if (servicioForm.cantidad > 10 && tipo !== 'WIFI' && tipo !== 'ASESORIA') p = p * 0.9; return (p * servicioForm.cantidad).toFixed(2); })()}</div>{servicioForm.cantidad > 10 && servicioForm.tipo !== 'WIFI' && servicioForm.tipo !== 'ASESORIA' && <div className="text-[10px] text-emerald-600 font-bold bg-emerald-100 px-2 py-0.5 rounded-full inline-block mt-1">‚ú® 10% Descuento Mayoreo</div>}</div></div><button onClick={agregarServicioACuenta} className="w-full bg-slate-900 hover:bg-black text-white py-3 rounded-lg font-bold shadow-lg flex justify-center items-center gap-2 transition-all transform active:scale-95"><CheckCircle size={20} className="text-emerald-400"/> Agregar a la Cuenta</button></div>
                                                <div className="mt-4 pt-4 border-t border-slate-200"><label className="block text-xs font-bold text-slate-500 mb-2">Agregar Cargo Manual</label><div className="flex gap-2"><input className="flex-1 border p-2 rounded text-sm" placeholder="Concepto (ej. Engargolado)" value={manualItemForm.nombre} onChange={e => setManualItemForm({...manualItemForm, nombre: e.target.value})} /><input className="w-20 border p-2 rounded text-sm" type="number" placeholder="$" value={manualItemForm.precio} onChange={e => setManualItemForm({...manualItemForm, precio: e.target.value})} /><button onClick={agregarManualACuenta} className="bg-slate-700 text-white px-3 rounded hover:bg-slate-800"><PlusCircle size={18}/></button></div></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="w-96 bg-white border-l border-slate-200 flex flex-col shadow-2xl z-20"><div className="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center"><div><h3 className="font-bold text-slate-700 text-sm uppercase tracking-wide">Cuenta Actual</h3><p className="text-[10px] text-slate-400">Resumen de consumos</p></div><span className="bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full text-xs font-bold">{eqSel.cuenta.length} Items</span></div><div className="flex-1 overflow-y-auto p-3 space-y-2 bg-slate-50/50">{eqSel.cuenta.map((i) => (<div key={i.uid} className="bg-white p-3 rounded-lg shadow-sm border border-slate-200 group relative hover:border-indigo-300 transition-all"><div className="flex justify-between items-start pr-6"><div><div className="font-bold text-sm text-slate-800 leading-tight">{i.nombre}</div>{i.esManual && <span className="text-[10px] bg-slate-100 px-1 rounded text-slate-500">Manual</span>}</div><div className="text-right"><div className="font-bold text-emerald-600 text-sm">${(i.precio * (i.cantidad || 1)).toFixed(2)}</div><div className="text-[10px] text-slate-400">{i.cantidad} x ${i.precio}</div></div></div><button onClick={() => eliminarProductoDeCuenta(i.uid)} className="absolute top-2 right-2 p-1.5 text-slate-300 hover:text-rose-500 hover:bg-rose-50 rounded-full transition-colors" title="Eliminar"><X size={14}/></button></div>))}{eqSel.cuenta.length === 0 && (<div className="flex flex-col items-center justify-center h-full text-slate-400 opacity-60"><ShoppingBag size={48} className="mb-2 stroke-1"/><span className="text-xs font-medium">Carrito vac√≠o</span><span className="text-[10px]">Agregue productos o servicios</span></div>)}</div><div className="bg-white border-t border-slate-200 p-5 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]"><div className="space-y-1 mb-4"><div className="flex justify-between text-xs text-slate-500"><span>Subtotal Productos</span><span>${eqSel.cuenta.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0).toFixed(2)}</span></div><div className="flex justify-between text-xs text-slate-500"><span>Renta Estimada (Tiempo)</span><span>${calcularTotalRenta(eqSel).toFixed(2)}</span></div></div><div className="flex justify-between items-center pt-3 border-t border-dashed border-slate-300 mb-4"><span className="font-bold text-lg text-slate-700">Total a Pagar</span><span className="font-black text-2xl text-indigo-600 tracking-tight">${(calcularTotalRenta(eqSel) + eqSel.cuenta.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0)).toFixed(2)}</span></div><button onClick={() => setModalAbierto('cobrar')} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-bold shadow-lg shadow-emerald-200 transition-all transform hover:-translate-y-0.5 active:translate-y-0 flex justify-center items-center gap-2"><Ticket size={18}/> Cobrar Cuenta</button></div></div>
                                </div>
                             </div>
                        </div>
                    )}

                    {/* --- MODAL DE CONFIRMACI√ìN DE RESET --- */}
                    {confirmarResetId && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[80] fade-anim">
                            <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full modal-anim text-center">
                                <div className="mb-4 text-rose-600 flex justify-center"><AlertTriangle size={48}/></div>
                                <h3 className="font-bold text-lg mb-2 text-slate-800">¬øReiniciar Estaci√≥n?</h3>
                                <p className="text-sm text-slate-500 mb-6">Se perder√° el tiempo y el consumo actual sin cobrar. Esta acci√≥n no se puede deshacer.</p>
                                <div className="flex gap-2">
                                    <button onClick={() => setConfirmarResetId(null)} className="flex-1 border py-2 rounded text-slate-600 font-bold hover:bg-slate-50">Cancelar</button>
                                    <button onClick={ejecutarReset} className="flex-1 bg-rose-600 text-white py-2 rounded font-bold hover:bg-rose-700 shadow-lg">S√≠, Reiniciar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- OTROS MODALES (PIN, INTERCAMBIO, PREPAGO, COBRO, RESPALDO, ETC) MANTENIDOS --- */}
                    {modalAbierto === 'cambiar_pin' && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[70] p-4 fade-anim">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden modal-anim">
                                <div className="bg-slate-800 p-4 text-white flex justify-between items-center"><h2 className="font-bold flex gap-2"><Key className="text-yellow-400"/> Seguridad</h2><button onClick={() => setModalAbierto(null)}><X/></button></div>
                                <div className="p-6 space-y-4">
                                    <p className="text-sm text-slate-500 mb-2">Cambiar contrase√±a para: <span className="font-bold text-slate-800">{usuarioActual.nombre}</span></p>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">Nuevo PIN</label><input type="password" maxLength="4" className="w-full border-2 border-slate-200 rounded-lg p-2 text-center text-xl tracking-widest outline-none focus:border-indigo-500" value={pinData.nuevo} onChange={e => setPinData({...pinData, nuevo: e.target.value.replace(/\D/g,'')})} autoFocus /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">Confirmar PIN</label><input type="password" maxLength="4" className="w-full border-2 border-slate-200 rounded-lg p-2 text-center text-xl tracking-widest outline-none focus:border-indigo-500" value={pinData.confirmar} onChange={e => setPinData({...pinData, confirmar: e.target.value.replace(/\D/g,'')})} /></div>
                                    <button onClick={actualizarPin} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold shadow-lg mt-4 flex justify-center items-center gap-2"><Save size={18}/> Guardar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {modalAbierto === 'intercambio' && eqSel && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                             <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md modal-anim">
                                <h2 className="font-bold mb-2 flex items-center gap-2 text-slate-700"><ArrowRightLeft/> Mover {eqSel.nombre}</h2>
                                <p className="text-sm text-slate-500 mb-4">Selecciona destino:</p>
                                <div className="grid grid-cols-2 gap-2 max-h-60 overflow-y-auto">{equipos.filter(e => e.estado === 'libre' && e.id !== eqSel.id).map(e => (<button key={e.id} onClick={() => confirmarIntercambio(e.id)} className="border p-3 rounded hover:bg-indigo-50 font-bold text-left flex items-center gap-2">{e.tipo === 'PC' ? <Monitor size={16}/> : <Gamepad2 size={16}/>} {e.nombre}</button>))}</div>
                                <button onClick={() => setModalAbierto(null)} className="mt-4 w-full border py-2 rounded text-slate-500 hover:bg-slate-100">Cancelar</button>
                             </div>
                        </div>
                    )}

                    {modalAbierto === 'prepago' && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden modal-anim">
                                <div className="bg-indigo-600 p-4 text-white flex justify-between items-center"><h2 className="font-bold flex gap-2"><Timer/> Prepago</h2><button onClick={() => setModalAbierto(null)}><X/></button></div>
                                <div className="p-6 space-y-4">
                                    <div className="text-center text-sm text-slate-500 mb-4">Configurando: <span className="font-bold text-slate-800">{eqSel.nombre}</span><br/>Tarifa: ${eqSel.precioHora}/hr</div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">Por Dinero ($)</label><div className="relative"><span className="absolute left-3 top-2.5 text-slate-400 font-bold">$</span><input type="number" className="w-full border-2 border-slate-200 rounded-lg p-2 pl-8 focus:border-indigo-500 outline-none font-bold text-lg" placeholder="0.00" value={prepagoData.dinero} onChange={e => setPrepagoData({ dinero: e.target.value, minutos: '' })} autoFocus /></div>{prepagoData.dinero && <p className="text-right text-xs text-emerald-600 font-bold mt-1">= {((parseFloat(prepagoData.dinero) / eqSel.precioHora) * 60).toFixed(0)} min</p>}</div>
                                    <div className="flex items-center gap-2"><div className="h-px bg-slate-200 flex-1"></div><span className="text-xs text-slate-400">O BIEN</span><div className="h-px bg-slate-200 flex-1"></div></div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">Por Tiempo (Minutos)</label><input type="number" className="w-full border-2 border-slate-200 rounded-lg p-2 focus:border-indigo-500 outline-none text-center" placeholder="Ej. 30" value={prepagoData.minutos} onChange={e => setPrepagoData({ minutos: e.target.value, dinero: '' })} /></div>
                                    <button onClick={aplicarPrepago} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold shadow-lg mt-4 flex justify-center items-center gap-2"><Play size={18}/> Iniciar</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {modalAbierto === 'cobrar' && eqSel && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md modal-anim">
                                <div className="bg-slate-800 p-4 text-white flex justify-between items-center rounded-t-xl"><h2 className="font-bold flex items-center gap-2"><Ticket className="text-emerald-400" /> Checkout</h2><button onClick={() => setModalAbierto(null)}><X /></button></div>
                                <div className="p-6 space-y-4">
                                    <div><label className="text-xs font-bold text-slate-500 uppercase">Cliente</label><select className="w-full border p-2 rounded mt-1 text-sm bg-slate-50" value={checkoutData.clienteId || 1} onChange={e => setCheckoutData({ ...checkoutData, clienteId: parseInt(e.target.value) })}>{clientes.map(c => <option key={c.id} value={c.id}>{c.nombre} {c.id !== 1 ? `(${c.puntos} pts)` : ''}</option>)}</select></div>
                                    <div className="bg-slate-50 p-4 rounded border space-y-2 text-sm">
                                        <div className="flex justify-between"><span>Renta</span><span>${calcularTotalRenta(eqSel).toFixed(2)}</span></div>
                                        <div className="flex justify-between"><span>Productos</span><span>${eqSel.cuenta.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0).toFixed(2)}</span></div>
                                        <div className="border-t pt-2 flex justify-between items-center text-lg font-bold text-slate-800"><span>TOTAL</span><span>${(calcularTotalRenta(eqSel) + eqSel.cuenta.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0)).toFixed(2)}</span></div>
                                        
                                        {/* PAGO CON y CAMBIO en Estaci√≥n */}
                                        <div className="mt-2 pt-2 border-t border-slate-200">
                                            <div className="flex items-center gap-2 mb-1">
                                                <label className="text-xs font-bold text-slate-500 w-20">Paga con:</label>
                                                <input type="number" className="flex-1 border p-1 rounded text-sm font-bold text-right" placeholder="$0.00" value={checkoutData.pagoCon} onChange={e => setCheckoutData({...checkoutData, pagoCon: e.target.value})}/>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <label className="text-xs font-bold text-slate-500 w-20">Cambio:</label>
                                                <div className="flex-1 text-right text-lg font-black text-emerald-600">${(parseFloat(checkoutData.pagoCon) - (calcularTotalRenta(eqSel) + eqSel.cuenta.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0))).toFixed(2)}</div>
                                            </div>
                                        </div>

                                    </div>
                                    {checkoutData.clienteId !== 1 ? (<div className="text-center text-xs text-emerald-600 bg-emerald-50 p-2 rounded border border-emerald-100">Este cliente ganar√° <b>{Math.floor((calcularTotalRenta(eqSel) + eqSel.cuenta.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0)) * RATIO_PUNTOS)}</b> puntos con esta compra.</div>) : (<div className="text-center text-xs text-slate-400 bg-slate-50 p-2 rounded border border-slate-100">Cliente General: <b>No acumula puntos</b>.</div>)}
                                    <button onClick={procesarCobro} className="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold hover:bg-emerald-700 shadow-lg flex justify-center items-center gap-2"><CheckCircle /> Terminar y Cobrar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL BACKUP (RESPALDO) --- */}
                    {modalAbierto === 'backup' && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden modal-anim">
                                <div className="bg-amber-500 p-4 text-white flex justify-between items-center"><h2 className="font-bold flex gap-2 items-center"><Database/> Respaldo y Migraci√≥n</h2><button onClick={() => setModalAbierto(null)}><X/></button></div>
                                <div className="p-6 space-y-6">
                                    <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                                        <h3 className="font-bold text-amber-800 mb-2 flex items-center gap-2"><Download size={20}/> Exportar Datos</h3>
                                        <p className="text-sm text-amber-700 mb-4">Descarga un archivo con toda la informaci√≥n actual (Clientes, Ventas, Configuraci√≥n) para guardarlo o llevarlo a otra PC.</p>
                                        <button onClick={handleExport} className="w-full bg-amber-600 hover:bg-amber-700 text-white py-2 rounded font-bold shadow transition-all">Descargar Respaldo (.json)</button>
                                    </div>

                                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                        <h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2"><Upload size={20}/> Importar Datos</h3>
                                        <p className="text-sm text-slate-600 mb-4">Carga un archivo de respaldo previamente descargado. <span className="font-bold text-rose-600">¬°Cuidado! Esto sobrescribir√° los datos actuales.</span></p>
                                        <input type="file" accept=".json" onChange={handleImport} className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- CHAT I.A. --- */}
                    {chatAbierto && (
                        <div className="fixed bottom-4 right-4 w-80 h-96 bg-white rounded-xl shadow-2xl flex flex-col border border-slate-200 z-[60] modal-anim overflow-hidden">
                            <div className="bg-gradient-to-r from-purple-600 to-indigo-600 p-3 text-white flex justify-between items-center">
                                <div className="flex items-center gap-2"><Bot size={18}/><span className="font-bold text-sm">Asistente IA</span></div>
                                <button onClick={() => setChatAbierto(false)} className="hover:bg-white/20 p-1 rounded"><X size={16}/></button>
                            </div>
                            <div className="flex-1 bg-slate-50 p-3 overflow-y-auto space-y-3">
                                {mensajesChat.map((msg, i) => (
                                    <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} msg-anim`}>
                                        <div className={`max-w-[85%] p-2 rounded-lg text-xs ${msg.role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-700 rounded-tl-none shadow-sm'}`}>
                                            {msg.text}
                                        </div>
                                    </div>
                                ))}
                                {cargandoAI && <div className="text-xs text-slate-400 italic text-center animate-pulse">Escribiendo...</div>}
                                <div ref={chatEndRef}></div>
                            </div>
                            <div className="p-2 border-t bg-white flex gap-2">
                                <input className="flex-1 border rounded-full px-3 py-1.5 text-xs outline-none focus:border-indigo-500" placeholder="Escribe tu duda..." value={inputChat} onChange={e => setInputChat(e.target.value)} onKeyDown={e => e.key === 'Enter' && enviarMensajeIA()} />
                                <button onClick={enviarMensajeIA} className="bg-indigo-600 text-white p-1.5 rounded-full hover:bg-indigo-700"><Send size={16}/></button>
                            </div>
                        </div>
                    )}

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CiberManager />);
    </script>
</body>
</html>